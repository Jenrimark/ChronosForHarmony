import { router } from '@kit.ArkUI';
import { AuthService, UserInfo } from '../service/AuthService';
import { promptAction } from '@kit.ArkUI';

/**
 * ç™»å½•é¦–é¡µ
 */
@Entry
@Component
struct Index {
  @State isLoading: boolean = false;
  @State userInfo: UserInfo | null = null;
  @State loginStatus: string = 'æ¬¢è¿ä½¿ç”¨è¾°åº';

  private authService: AuthService = AuthService.getInstance();

  aboutToAppear(): void {
    // å°è¯•è·å–å½“å‰ç”¨æˆ·
    this.tryGetCurrentUser();
  }

  /**
   * å°è¯•è·å–å½“å‰ç™»å½•ç”¨æˆ·
   */
  async tryGetCurrentUser(): Promise<void> {
    this.isLoading = true;
    try {
      const user: UserInfo | null = await this.authService.getCurrentUserAsync();
      if (user) {
        this.userInfo = user;
        this.loginStatus = `æ¬¢è¿å›æ¥ï¼Œ${user.displayName}`;
      }
    } catch (e) {
      console.info('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨ç™»å½•');
    }
    this.isLoading = false;
  }

  /**
   * åä¸ºè´¦å·ç™»å½•
   */
  async handleHuaweiLogin(): Promise<void> {
    this.isLoading = true;
    this.loginStatus = 'æ­£åœ¨ç™»å½•...';
    try {
      const user: UserInfo | null = await this.authService.login();
      if (user) {
        this.userInfo = user;
        this.loginStatus = `ç™»å½•æˆåŠŸï¼Œ${user.displayName}`;
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸï¼' });
      } else {
        this.loginStatus = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }
    } catch (e) {
      this.loginStatus = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
    this.isLoading = false;
  }

  /**
   * è·³è½¬åˆ°ä¸»é¡µ
   */
  goToMain(): void {
    router.pushUrl({ url: 'pages/Main' });
  }

  /**
   * é€€å‡ºç™»å½•
   */
  async handleLogout(): Promise<void> {
    await this.authService.logout();
    this.userInfo = null;
    this.loginStatus = 'æ¬¢è¿ä½¿ç”¨è¾°åº';
    promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
  }

  build() {
    Column() {
      // Logo åŒºåŸŸ
      Column() {
        Text('ğŸ“…')
          .fontSize(80)
          .margin({ bottom: 16 })

        Text('è¾°åº')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Text('æ—¶é—´ç®¡ç† Â· ä»»åŠ¡è¿½è¸ª Â· æ™ºèƒ½è®°è´¦')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ top: 8 })
      }
      .margin({ top: 100, bottom: 60 })

      // çŠ¶æ€æ˜¾ç¤º
      Text(this.loginStatus)
        .fontSize(16)
        .fontColor('#666666')
        .margin({ bottom: 40 })

      // ç”¨æˆ·ä¿¡æ¯ï¼ˆå·²ç™»å½•æ—¶æ˜¾ç¤ºï¼‰
      if (this.userInfo) {
        Column() {
          if (this.userInfo.avatarUri) {
            Image(this.userInfo.avatarUri)
              .width(60)
              .height(60)
              .borderRadius(30)
              .margin({ bottom: 8 })
          }
          Text(this.userInfo.displayName)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .margin({ bottom: 30 })
      }

      // æŒ‰é’®åŒºåŸŸ
      Column() {
        // è¿›å…¥ä¸»é¡µæŒ‰é’®
        Button('è¿›å…¥ä¸»é¡µ')
          .width('80%')
          .height(50)
          .fontSize(18)
          .fontColor(Color.White)
          .backgroundColor('#4FC3F7')
          .borderRadius(25)
          .margin({ bottom: 16 })
          .onClick(() => this.goToMain())

        // åä¸ºè´¦å·ç™»å½•æŒ‰é’®
        if (!this.userInfo) {
          Button() {
            Row() {
              Text('ğŸ”')
                .fontSize(20)
                .margin({ right: 8 })
              Text('åä¸ºè´¦å·ç™»å½•')
                .fontSize(16)
                .fontColor('#333333')
            }
          }
          .width('80%')
          .height(50)
          .backgroundColor('#FFFFFF')
          .borderRadius(25)
          .border({ width: 1, color: '#DDDDDD' })
          .enabled(!this.isLoading)
          .onClick(() => this.handleHuaweiLogin())
        } else {
          // é€€å‡ºç™»å½•æŒ‰é’®
          Button('é€€å‡ºç™»å½•')
            .width('80%')
            .height(50)
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor('#F5F5F5')
            .borderRadius(25)
            .onClick(() => this.handleLogout())
        }
      }
      .width('100%')

      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 20 })
      }

      // åº•éƒ¨æç¤º
      Blank()

      Text('ç™»å½•åå¯åŒæ­¥æ•°æ®åˆ°äº‘ç«¯')
        .fontSize(12)
        .fontColor('#999999')
        .margin({ bottom: 40 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }
}
