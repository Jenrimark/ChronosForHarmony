import { Bill, BillType, BillCategory } from '../model/Bill';
import { Constants } from '../common/Constants';
import { promptAction } from '@kit.ArkUI';

/**
 * åˆ†ç±»é¡¹æ¥å£
 */
interface CategoryItem {
  category: BillCategory;
  icon: string;
  name: string;
}

/**
 * æ‰‹åŠ¨è®°è´¦å¼¹çª—ç»„ä»¶
 */
@Component
export struct ManualBillSheet {
  @Link isShow: boolean;
  onSave: (bill: Bill) => void = () => {};

  @State selectedType: BillType = BillType.EXPENSE;
  @State selectedCategory: BillCategory = BillCategory.FOOD;
  @State amountText: string = '';
  @State description: string = '';

  // æ”¯å‡ºåˆ†ç±»åˆ—è¡¨
  private expenseCategories: CategoryItem[] = [
    { category: BillCategory.FOOD, icon: 'ğŸ”', name: 'é¤é¥®' },
    { category: BillCategory.TRANSPORT, icon: 'ğŸš—', name: 'äº¤é€š' },
    { category: BillCategory.SHOPPING, icon: 'ğŸ›ï¸', name: 'è´­ç‰©' },
    { category: BillCategory.ENTERTAINMENT, icon: 'ğŸ¬', name: 'å¨±ä¹' },
    { category: BillCategory.MEDICAL, icon: 'ğŸ¥', name: 'åŒ»ç–—' },
    { category: BillCategory.EDUCATION, icon: 'ğŸ“š', name: 'æ•™è‚²' },
    { category: BillCategory.HOUSING, icon: 'ğŸ ', name: 'ä½æˆ¿' },
    { category: BillCategory.UTILITIES, icon: 'ğŸ’¡', name: 'æ°´ç”µ' },
    { category: BillCategory.OTHER_EXPENSE, icon: 'ğŸ“', name: 'å…¶ä»–' }
  ];

  // æ”¶å…¥åˆ†ç±»åˆ—è¡¨
  private incomeCategories: CategoryItem[] = [
    { category: BillCategory.SALARY, icon: 'ğŸ’°', name: 'å·¥èµ„' },
    { category: BillCategory.BONUS, icon: 'ğŸ', name: 'å¥–é‡‘' },
    { category: BillCategory.INVESTMENT, icon: 'ğŸ“ˆ', name: 'æŠ•èµ„' },
    { category: BillCategory.GIFT, icon: 'ğŸ€', name: 'ç¤¼é‡‘' },
    { category: BillCategory.OTHER_INCOME, icon: 'ğŸ“', name: 'å…¶ä»–' }
  ];

  /**
   * è·å–å½“å‰åˆ†ç±»åˆ—è¡¨
   */
  getCurrentCategories(): CategoryItem[] {
    return this.selectedType === BillType.EXPENSE
      ? this.expenseCategories
      : this.incomeCategories;
  }

  build() {
    Stack() {
      // åŠé€æ˜é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.isShow = false;
        })

      // å¼¹çª—å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('Ã—')
            .fontSize(24)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .onClick(() => {
              this.isShow = false;
            })

          Text('æ‰‹åŠ¨è®°è´¦')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Constants.COLOR_TEXT_PRIMARY)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Text('ä¿å­˜')
            .fontSize(16)
            .fontColor(Constants.COLOR_PRIMARY)
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              this.saveBill();
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 12 })

        // ç±»å‹åˆ‡æ¢
        Row() {
          this.buildTypeButton('æ”¯å‡º', BillType.EXPENSE)
          this.buildTypeButton('æ”¶å…¥', BillType.INCOME)
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
        .justifyContent(FlexAlign.Center)

        // é‡‘é¢è¾“å…¥
        Column() {
          Text(this.selectedType === BillType.EXPENSE ? 'æ”¯å‡ºé‡‘é¢' : 'æ”¶å…¥é‡‘é¢')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .margin({ bottom: 8 })

          Row() {
            Text('Â¥')
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(Constants.COLOR_TEXT_PRIMARY)

            TextInput({ placeholder: '0.00', text: this.amountText })
              .type(InputType.NUMBER_DECIMAL)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(Constants.COLOR_TEXT_PRIMARY)
              .backgroundColor('transparent')
              .layoutWeight(1)
              .onChange((value: string) => {
                this.amountText = value;
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })

        // åˆ†ç±»é€‰æ‹©
        Column() {
          Text('é€‰æ‹©åˆ†ç±»')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .margin({ bottom: 12 })
            .alignSelf(ItemAlign.Start)

          this.buildCategoryGrid()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })

        // å¤‡æ³¨è¾“å…¥
        Column() {
          Text('å¤‡æ³¨')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .margin({ bottom: 8 })
            .alignSelf(ItemAlign.Start)

          TextInput({ placeholder: 'æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰', text: this.description })
            .width('100%')
            .height(44)
            .fontSize(15)
            .backgroundColor(Constants.COLOR_BACKGROUND)
            .borderRadius(8)
            .padding({ left: 12, right: 12 })
            .onChange((value: string) => {
              this.description = value;
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 24 })

        // ä¿å­˜æŒ‰é’®
        Button('ä¿å­˜è´¦å•')
          .type(ButtonType.Normal)
          .width('90%')
          .height(50)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .fontColor('#FFFFFF')
          .borderRadius(25)
          .onClick(() => {
            this.saveBill();
          })
      }
      .width('100%')
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius({ topLeft: 20, topRight: 20 })
      .position({ x: 0, y: '100%' })
      .translate({ y: -480 })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildTypeButton(label: string, type: BillType) {
    Button(label)
      .type(ButtonType.Normal)
      .width(100)
      .height(40)
      .fontSize(15)
      .fontWeight(FontWeight.Medium)
      .backgroundColor(this.selectedType === type ? Constants.COLOR_PRIMARY : Constants.COLOR_BACKGROUND)
      .fontColor(this.selectedType === type ? '#FFFFFF' : Constants.COLOR_TEXT_SECONDARY)
      .borderRadius(20)
      .margin({ left: 8, right: 8 })
      .onClick(() => {
        this.selectedType = type;
        // åˆ‡æ¢ç±»å‹æ—¶é‡ç½®åˆ†ç±»
        if (type === BillType.EXPENSE) {
          this.selectedCategory = BillCategory.FOOD;
        } else {
          this.selectedCategory = BillCategory.SALARY;
        }
      })
  }

  @Builder
  buildCategoryGrid() {
    Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
      ForEach(this.getCurrentCategories(), (item: CategoryItem) => {
        Column() {
          Column() {
            Text(item.icon)
              .fontSize(24)
          }
          .width(50)
          .height(50)
          .backgroundColor(this.selectedCategory === item.category
            ? (this.selectedType === BillType.EXPENSE ? 'rgba(255, 107, 53, 0.15)' : 'rgba(255, 167, 38, 0.15)')
            : Constants.COLOR_BACKGROUND)
          .borderRadius(25)
          .justifyContent(FlexAlign.Center)
          .border({
            width: this.selectedCategory === item.category ? 2 : 0,
            color: this.selectedType === BillType.EXPENSE ? Constants.COLOR_PRIMARY : Constants.COLOR_SUCCESS
          })

          Text(item.name)
            .fontSize(12)
            .fontColor(this.selectedCategory === item.category
              ? Constants.COLOR_TEXT_PRIMARY
              : Constants.COLOR_TEXT_SECONDARY)
            .margin({ top: 6 })
        }
        .width('33.33%')
        .padding(8)
        .onClick(() => {
          this.selectedCategory = item.category;
        })
      })
    }
    .width('100%')
  }

  /**
   * ä¿å­˜è´¦å•
   */
  saveBill(): void {
    const amount = parseFloat(this.amountText);
    if (isNaN(amount) || amount <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢' });
      return;
    }

    const bill = new Bill();
    bill.type = this.selectedType;
    bill.category = this.selectedCategory;
    bill.amount = amount;
    bill.description = this.description;
    bill.date = new Date();

    this.onSave(bill);
    this.resetForm();
    this.isShow = false;
  }

  /**
   * é‡ç½®è¡¨å•
   */
  resetForm(): void {
    this.selectedType = BillType.EXPENSE;
    this.selectedCategory = BillCategory.FOOD;
    this.amountText = '';
    this.description = '';
  }
}
