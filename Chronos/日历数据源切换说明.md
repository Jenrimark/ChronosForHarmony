# 日历数据源切换功能说明

## 功能概述

辰序应用支持两种日历数据源，用户可以在设置页面随时切换：

- **本地数据源（0）**：使用应用内置的本地JSON文件，离线可用，但数据可能不够准确
- **API数据源（1）**：调用 mxnzp.com API 获取实时节假日数据，需要网络，数据更准确

## 实现位置

### 1. 配置常量（Constants.ets）

```typescript
// 数据源配置
static readonly PREF_CALENDAR_DATA_SOURCE: string = 'calendar_data_source'; // 0=本地数据, 1=API数据
static readonly DATA_SOURCE_LOCAL: number = 0;  // 本地数据
static readonly DATA_SOURCE_API: number = 1;     // API数据

// mxnzp API配置
static readonly MXNZP_APP_ID: string = 'fjltrolmimk0nafq';
static readonly MXNZP_APP_SECRET: string = 'S7ckQECIjhoMcDxBOyRSRXlafe0VxCBZ';
static readonly MXNZP_HOLIDAY_URL: string = 'https://www.mxnzp.com/api/holiday/list/year';
```

### 2. 服务层（HolidayService.ets）

**核心功能**：
- `getDataSource()`: 获取当前数据源
- `setDataSource(source: number)`: 设置数据源（0或1）
- `getHolidayByDate()`: 根据数据源自动选择获取方式
- `loadYearDataFromAPI()`: 从API加载整年数据
- `getDataFromLocal()`: 从本地数据获取（降级方案）

**数据缓存机制**：
- 本地数据：加载后缓存在内存中
- API数据：按年份缓存，避免重复请求
- 切换数据源时自动清空缓存

### 3. 设置页面（Settings.ets）

在设置页面顶部添加了数据源切换开关：

```typescript
@Builder
buildDataSourceSwitchItem() {
  Row() {
    Column() {
      Text('日历数据源')
      Text(this.calendarDataSource === Constants.DATA_SOURCE_LOCAL 
        ? '使用本地日历数据（离线可用）' 
        : '使用API日历数据（需要网络，数据更准确）')
    }
    .layoutWeight(1)

    Toggle({ type: ToggleType.Switch, isOn: this.calendarDataSource === Constants.DATA_SOURCE_API })
      .onChange((isOn: boolean) => {
        this.switchCalendarDataSource(isOn);
      })
  }
}
```

## 使用方式

### 用户操作

1. 打开应用，进入"设置"页面
2. 在设置列表顶部找到"日历数据源"选项
3. 点击开关切换数据源：
   - **关闭（本地数据）**：使用本地JSON文件，离线可用
   - **打开（API数据）**：使用API获取数据，需要网络

### 切换效果

- 切换后立即生效
- 自动清空缓存，重新加载数据
- 显示提示："已切换为XX数据，请刷新日历查看效果"
- 如果API失败，自动降级到本地数据

## 技术实现细节

### 1. 数据源存储

使用 `Preferences` 存储用户选择的数据源：

```typescript
// 保存
await this.preferencesStore.put(Constants.PREF_CALENDAR_DATA_SOURCE, source);
await this.preferencesStore.flush();

// 读取
const savedSource = await this.preferencesStore.get(
  Constants.PREF_CALENDAR_DATA_SOURCE, 
  Constants.DATA_SOURCE_LOCAL
);
```

### 2. API调用

**接口地址**：
```
https://www.mxnzp.com/api/holiday/list/year/{year}?ignoreHoliday=false&app_id={app_id}&app_secret={app_secret}
```

**请求方式**：GET

**响应格式**：
```json
{
  "code": 1,
  "msg": "success",
  "data": [
    {
      "date": "2025-01-01",
      "weekDay": 3,
      "type": 2,
      "typeDes": "元旦",
      "lunarCalendar": "十二月初二",
      "solarTerms": "无",
      ...
    }
  ]
}
```

### 3. 降级处理

当API调用失败时，自动降级到本地数据：

```typescript
try {
  // 尝试从API获取
  mxnzpData = await this.getDataFromAPI(date);
} catch (error) {
  // API失败，降级到本地数据
  console.warn('API获取失败，使用本地数据');
  mxnzpData = await this.getDataFromLocal(date);
}
```

### 4. 缓存策略

- **本地数据**：应用启动时加载一次，缓存在内存中
- **API数据**：按年份缓存，避免重复请求同一年的数据
- **切换数据源**：自动清空所有缓存，强制重新加载

## 优势

1. **灵活性**：用户可以根据网络情况选择数据源
2. **可靠性**：API失败时自动降级，保证功能可用
3. **性能**：按年份缓存API数据，减少网络请求
4. **用户体验**：切换简单，立即生效

## 注意事项

1. **网络要求**：使用API数据源需要网络连接
2. **API限制**：注意API调用频率限制，避免频繁请求
3. **数据准确性**：API数据更准确，包含最新的节假日信息
4. **离线使用**：本地数据源支持完全离线使用

## 测试建议

1. **切换测试**：在设置页面切换数据源，检查日历是否正确更新
2. **网络测试**：断开网络，切换到API数据源，检查降级是否正常
3. **缓存测试**：切换数据源后，检查缓存是否清空
4. **性能测试**：检查API数据加载速度，确保用户体验良好

