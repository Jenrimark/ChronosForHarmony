import { CalendarEvent } from '../../model/CalendarEvent';
import { Constants } from '../../common/Constants';

/**
 * äº‹ä»¶å—ç»„ä»¶
 * åœ¨æ—¶é—´è½´ä¸Šæ˜¾ç¤ºæ—¥ç¨‹äº‹ä»¶
 */
@Component
export struct EventBlock {
  @Prop event: CalendarEvent = new CalendarEvent();
  @Prop hourHeight: number = 60; // æ¯å°æ—¶çš„é«˜åº¦
  onEventTap: (event: CalendarEvent) => void = () => {};

  /**
   * è®¡ç®—äº‹ä»¶å—çš„é¡¶éƒ¨ä½ç½®
   */
  getTopPosition(): number {
    const startHour = this.event.startTime.getHours();
    const startMinute = this.event.startTime.getMinutes();
    return (startHour + startMinute / 60) * this.hourHeight;
  }

  /**
   * è®¡ç®—äº‹ä»¶å—çš„é«˜åº¦
   */
  getBlockHeight(): number {
    const startTime = this.event.startTime.getTime();
    const endTime = this.event.endTime.getTime();
    const durationHours = (endTime - startTime) / (1000 * 60 * 60);
    const height = durationHours * this.hourHeight;
    // æœ€å°é«˜åº¦20
    return Math.max(height, 20);
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  formatTime(date: Date): string {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const h = hours < 10 ? `0${hours}` : `${hours}`;
    const m = minutes < 10 ? `0${minutes}` : `${minutes}`;
    return `${h}:${m}`;
  }

  /**
   * è·å–äº‹ä»¶é¢œè‰²
   */
  getEventColor(): string {
    // å¯ä»¥æ ¹æ®äº‹ä»¶ç±»å‹æˆ–é‡è¦æ€§è¿”å›ä¸åŒé¢œè‰²
    if (this.event.priority) {
      return '#FF6B35';
    }
    return Constants.COLOR_PRIMARY;
  }

  build() {
    Column() {
      // äº‹ä»¶æ ‡é¢˜
      Text(this.event.title)
        .fontSize(12)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')

      // æ—¶é—´èŒƒå›´ï¼ˆå¦‚æœé«˜åº¦è¶³å¤Ÿï¼‰
      if (this.getBlockHeight() > 35) {
        Text(`${this.formatTime(this.event.startTime)} - ${this.formatTime(this.event.endTime)}`)
          .fontSize(10)
          .fontColor('rgba(255,255,255,0.8)')
          .margin({ top: 2 })
      }

      // åœ°ç‚¹ï¼ˆå¦‚æœé«˜åº¦è¶³å¤Ÿä¸”æœ‰åœ°ç‚¹ï¼‰
      if (this.getBlockHeight() > 50 && this.event.location.length > 0) {
        Text(`ğŸ“ ${this.event.location}`)
          .fontSize(10)
          .fontColor('rgba(255,255,255,0.7)')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 2 })
      }
    }
    .width('90%')
    .height(this.getBlockHeight())
    .padding(6)
    .backgroundColor(this.getEventColor())
    .borderRadius(6)
    .position({ x: 50, y: this.getTopPosition() })
    .onClick(() => {
      this.onEventTap(this.event);
    })
  }
}
