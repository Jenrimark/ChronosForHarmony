import { Constants } from '../common/Constants';
import { ChatService } from '../service/ChatService';
import { NormalMsgView } from '../components/chat/NormalMsgView';
import { ChatInputView } from '../components/chat/ChatInputView';
import { MsgTimeView } from '../components/chat/MsgTimeView';
import MsgSendStatus from '../components/chat/MsgSendStatus';

/**
 * å¯¹è¯é¡µé¢
 * å‚è€ƒharmonychat-mainé¡¹ç›®çš„è®¾è®¡ï¼Œä½¿ç”¨æ”¹è¿›çš„UIç»„ä»¶
 */
@Component
export struct Chat {
  @State messages: ChatMessage[] = [];
  @State inputText: string = '';
  @State isSending: boolean = false; // æ˜¯å¦æ­£åœ¨å‘é€æ¶ˆæ¯
  @State apiStatus: string = ''; // APIæµ‹è¯•çŠ¶æ€

  // èŠå¤©åˆ—è¡¨çš„æ»šåŠ¨æ¡ç»„ä»¶
  private scroller: Scroller = new Scroller();

  private chatService: ChatService = ChatService.getInstance();

  aboutToAppear() {
    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
    this.messages = [
      {
        id: 1,
        content: 'ä½ å¥½ï¼æˆ‘æ˜¯è¾°åºåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ï¼ğŸ˜Š\n\næ— è®ºä½ æ˜¯æƒ³ç®¡ç†æ—¥å¸¸ä»»åŠ¡ã€è®°å½•æ”¶æ”¯ã€è§„åˆ’æ—¥ç¨‹ï¼Œè¿˜æ˜¯éœ€è¦ä¸€äº›å®ç”¨å»ºè®®ï¼Œæˆ‘éƒ½å¯ä»¥å¸®ä½ ã€‚\n\nä»Šå¤©æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥ååŠ©ä½ çš„å—ï¼Ÿ',
        isUser: false,
        timestamp: new Date(),
        sendStatus: MsgSendStatus.success
      }
    ];
  }

  /**
   * åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´ï¼ˆä»¿å¾®ä¿¡é€»è¾‘ï¼šè¶…è¿‡2åˆ†é’Ÿæ‰æ˜¾ç¤ºï¼‰
   */
  shouldShowTime(currentMsg: ChatMessage, previousMsg: ChatMessage | null): boolean {
    if (!previousMsg) {
      return true; // ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¾ç¤ºæ—¶é—´
    }
    const timeDiff = currentMsg.timestamp.getTime() - previousMsg.timestamp.getTime();
    return timeDiff > 2 * 60 * 1000; // è¶…è¿‡2åˆ†é’Ÿ
  }

  /**
   * æ»šåŠ¨æ¶ˆæ¯åˆ—è¡¨åˆ°æœ€åº•éƒ¨
   */
  scrollToBottom() {
    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Bottom);
    }, 100);
  }

  /**
   * æµ‹è¯•APIè¿æ¥
   */
  async testAPI(): Promise<void> {
    this.apiStatus = 'æµ‹è¯•ä¸­...';
    try {
      const testMessage = 'ä½ å¥½';
      const response = await this.chatService.sendMessage(testMessage);
      this.apiStatus = `âœ… APIæ­£å¸¸ï¼š${response.substring(0, 50)}...`;

      // æ·»åŠ æµ‹è¯•æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
      const testUserMsg: ChatMessage = {
        id: this.messages.length + 1,
        content: `[æµ‹è¯•] ${testMessage}`,
        isUser: true,
        timestamp: new Date(),
        sendStatus: MsgSendStatus.success
      };
      const testAiMsg: ChatMessage = {
        id: this.messages.length + 2,
        content: `[æµ‹è¯•å›å¤] ${response}`,
        isUser: false,
        timestamp: new Date()
      };
      const newTestMessages: ChatMessage[] = [];
      for (let i = 0; i < this.messages.length; i++) {
        newTestMessages.push(this.messages[i]);
      }
      newTestMessages.push(testUserMsg);
      newTestMessages.push(testAiMsg);
      this.messages = newTestMessages;
      this.scrollToBottom();
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      this.apiStatus = `âŒ APIé”™è¯¯ï¼š${errorMessage}`;
      console.error('APIæµ‹è¯•å¤±è´¥:', errorMessage);
    }
  }

  /**
   * å‘é€æ¶ˆæ¯ï¼ˆæµå¼è¾“å‡ºï¼‰
   */
  async sendMessage(): Promise<void> {
    if (!this.inputText.trim() || this.isSending) {
      return;
    }

    const currentInput = this.inputText.trim();
    // å…ˆæ¸…ç©ºè¼¸å…¥æ¡†ï¼Œæ”¹å–„ç”¨æˆ¶é«”é©—
    this.inputText = '';
    this.isSending = true;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: ChatMessage = {
      id: this.messages.length + 1,
      content: currentInput,
      isUser: true,
      timestamp: new Date(),
      sendStatus: MsgSendStatus.sending
    };
    const newMessages1: ChatMessage[] = [];
    for (let i = 0; i < this.messages.length; i++) {
      newMessages1.push(this.messages[i]);
    }
    newMessages1.push(userMessage);
    this.messages = newMessages1;
    this.scrollToBottom();

    // æ·»åŠ ä¸€ä¸ªåŠ è½½ä¸­çš„AIæ¶ˆæ¯å ä½
    const loadingMessageId = this.messages.length + 1;
    const loadingMessage: ChatMessage = {
      id: loadingMessageId,
      content: '',
      isUser: false,
      timestamp: new Date()
    };
    const newMessages2: ChatMessage[] = [];
    for (let i = 0; i < this.messages.length; i++) {
      newMessages2.push(this.messages[i]);
    }
    newMessages2.push(loadingMessage);
    this.messages = newMessages2;
    this.scrollToBottom();

    try {
      // ä½¿ç”¨å±€éƒ¨å˜é‡ç´¯ç§¯å†…å®¹ï¼Œé¿å…åœ¨å¼‚æ­¥å›è°ƒä¸­é¢‘ç¹è¯»å–çŠ¶æ€
      let accumulatedContent: string = '';

      // è°ƒç”¨æµå¼APIè·å–AIå›å¤
      await this.chatService.sendMessageStream(
        currentInput,
        (chunk: string) => {
          console.info('æ”¶åˆ°chunkï¼Œé•¿åº¦:', chunk.length, 'å†…å®¹é¢„è§ˆ:', chunk.substring(0, 20));

          // ç´¯ç§¯å†…å®¹
          accumulatedContent += chunk;
          console.info('ç´¯ç§¯å†…å®¹æ€»é•¿åº¦:', accumulatedContent.length);

          // ä»å½“å‰çŠ¶æ€ä¸­æŸ¥æ‰¾åŠ è½½æ¶ˆæ¯çš„ç´¢å¼•
          const loadingIndex = this.messages.findIndex((msg: ChatMessage) => msg.id === loadingMessageId);
          if (loadingIndex < 0) {
            console.error('æœªæ‰¾åˆ°åŠ è½½æ¶ˆæ¯ï¼ŒloadingMessageId:', loadingMessageId);
            return;
          }

          const currentLoadingMsg = this.messages[loadingIndex];

          // åˆ›å»ºæ–°æ•°ç»„ï¼Œæ›¿æ¢ç›®æ ‡æ¶ˆæ¯
          const updatedMessages: ChatMessage[] = [];
          for (let i = 0; i < this.messages.length; i++) {
            if (i === loadingIndex) {
              // æ›´æ–°åŠ è½½ä¸­çš„æ¶ˆæ¯ï¼Œæœ‰å†…å®¹åä¸å†æ˜¾ç¤ºloadingçŠ¶æ€
              updatedMessages.push({
                id: currentLoadingMsg.id,
                content: accumulatedContent,
                isUser: currentLoadingMsg.isUser,
                timestamp: new Date(),
                sendStatus: MsgSendStatus.success
              });
            } else if (this.messages[i].id === userMessage.id) {
              // åŒæ—¶æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºæˆåŠŸï¼ˆå¦‚æœè¿˜æ²¡æœ‰æ›´æ–°ï¼‰
              const originalMsg = this.messages[i];
              updatedMessages.push({
                id: originalMsg.id,
                content: originalMsg.content,
                isUser: originalMsg.isUser,
                timestamp: originalMsg.timestamp,
                sendStatus: MsgSendStatus.success
              });
            } else {
              updatedMessages.push(this.messages[i]);
            }
          }

          // ç¡®ä¿çŠ¶æ€æ›´æ–°è§¦å‘UIåˆ·æ–°
          this.messages = updatedMessages;
          this.scrollToBottom();
        }
      );

      // æµå¼è¾“å‡ºå®Œæˆåï¼Œç¡®ä¿ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºæˆåŠŸï¼ˆåŒé‡ä¿é™©ï¼‰
      const finalUserMsgIndex = this.messages.findIndex((msg: ChatMessage) => msg.id === userMessage.id);
      if (finalUserMsgIndex >= 0 && this.messages[finalUserMsgIndex].sendStatus === MsgSendStatus.sending) {
        const updatedMessages: ChatMessage[] = [];
        for (let i = 0; i < this.messages.length; i++) {
          if (i === finalUserMsgIndex) {
            const originalMsg = this.messages[i];
            updatedMessages.push({
              id: originalMsg.id,
              content: originalMsg.content,
              isUser: originalMsg.isUser,
              timestamp: originalMsg.timestamp,
              sendStatus: MsgSendStatus.success
            });
          } else {
            updatedMessages.push(this.messages[i]);
          }
        }
        this.messages = updatedMessages;
      }
    } catch (error) {
      // é”™è¯¯å¤„ç†
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', errorMessage);

      // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ä¸ºå¤±è´¥
      const userMsgIndex = this.messages.findIndex((msg: ChatMessage) => msg.id === userMessage.id);
      if (userMsgIndex >= 0) {
        const updatedMessages: ChatMessage[] = [];
        for (let i = 0; i < this.messages.length; i++) {
          if (i === userMsgIndex) {
            // æ‰‹åŠ¨å¤åˆ¶å¯¹è±¡å¹¶æ›´æ–°sendStatus
            const originalMsg = this.messages[i];
            updatedMessages.push({
              id: originalMsg.id,
              content: originalMsg.content,
              isUser: originalMsg.isUser,
              timestamp: originalMsg.timestamp,
              sendStatus: MsgSendStatus.sendFailed
            });
          } else {
            updatedMessages.push(this.messages[i]);
          }
        }
        this.messages = updatedMessages;
      }

      // æ›´æ–°é”™è¯¯æ¶ˆæ¯
      let friendlyErrorMessage = 'æŠ±æ­‰ï¼Œç™¼é€æ¶ˆæ¯æ™‚å‡ºç¾éŒ¯èª¤';
      if (errorMessage.includes('ç¶²çµ¡') || errorMessage.includes('network') || errorMessage.includes('timeout')) {
        friendlyErrorMessage = 'ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡è¨­ç½®';
      } else if (errorMessage.includes('API') || errorMessage.includes('MIMO')) {
        friendlyErrorMessage = 'AIæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦';
      } else if (errorMessage.includes('è§£æ') || errorMessage.includes('parse')) {
        friendlyErrorMessage = 'æœå‹™éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
      } else {
        friendlyErrorMessage = `ç™¼é€å¤±æ•—ï¼š${errorMessage.substring(0, 100)}`;
      }

      const errorMsg: ChatMessage = {
        id: loadingMessageId,
        content: friendlyErrorMessage,
        isUser: false,
        timestamp: new Date()
      };

      const loadingIndex = this.messages.findIndex((msg: ChatMessage) => msg.id === loadingMessageId);
      if (loadingIndex >= 0) {
        const updatedMessages: ChatMessage[] = [];
        for (let i = 0; i < this.messages.length; i++) {
          if (i === loadingIndex) {
            updatedMessages.push(errorMsg);
          } else {
            updatedMessages.push(this.messages[i]);
          }
        }
        this.messages = updatedMessages;
      }
    } finally {
      this.isSending = false;
    }
  }

  build() {
    Column() {
      // APIæµ‹è¯•çŠ¶æ€æ ï¼ˆå¼€å‘æ—¶æ˜¾ç¤ºï¼‰
      if (this.apiStatus) {
        Row() {
          Text(this.apiStatus)
            .fontSize(12)
            .fontColor(this.apiStatus.startsWith('âœ…') ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER)
            .margin({ left: 16, right: 16, top: 8, bottom: 4 })
        }
        .width('100%')
      }

      // æµ‹è¯•æŒ‰é’®ï¼ˆå¼€å‘æ—¶æ˜¾ç¤ºï¼‰
      if (this.apiStatus) {
        Row() {
          Button('æµ‹è¯•APIè¿æ¥')
            .type(ButtonType.Normal)
            .fontSize(12)
            .backgroundColor(Constants.COLOR_INFO)
            .fontColor('#FFFFFF')
            .height(32)
            .margin({ left: 16, right: 16, bottom: 8 })
            .enabled(!this.isSending)
            .onClick(() => {
              this.testAPI();
            })
        }
        .width('100%')
      }

      // èŠå¤©ç•Œé¢å†…å®¹åŒº
      Column() {
        List({ scroller: this.scroller }) {
          ForEach(this.messages, (message: ChatMessage, index: number) => {
            ListItem() {
              Column() {
                // æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´
                MsgTimeView({
                  message: message,
                  showTime: this.shouldShowTime(message, index > 0 ? this.messages[index - 1] : null)
                })

                // æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
                if (!message.content || message.content.trim() === '') {
                  // åŠ è½½ä¸­çš„æ¶ˆæ¯
                  this.buildLoadingMessage()
                } else {
                  NormalMsgView({
                    message: message,
                    sendStatus: message.sendStatus ?? MsgSendStatus.success
                  })
                }
              }
            }
            .margin({ top: index === 0 ? 15 : 0, bottom: 15 })
          }, (message: ChatMessage) => `${message.id}-${message.content.length}-${message.timestamp.getTime()}`)
        }
        .onTouch(() => {
          // ç‚¹å‡»åˆ—è¡¨åŒºåŸŸæ—¶ï¼Œå¯ä»¥æ”¶èµ·è½¯é”®ç›˜
          // ToolKits.hideSoftInputMethod(this.getUIContext());
        })
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .width("100%")
        .height('100%')
        .layoutWeight(1)
        .listDirection(Axis.Vertical)
        .backgroundColor(Constants.COLOR_BACKGROUND)
      }
      .layoutWeight(1)
      .backgroundColor(Constants.COLOR_BACKGROUND)

      // åº•éƒ¨æ¶ˆæ¯è¾“å…¥åŒº
      ChatInputView({
        isSending: this.isSending,
        onSendClick: (message: string) => {
          this.inputText = message;
          this.sendMessage();
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  buildLoadingMessage() {
    Row() {
      // AIå¤´åƒ
      Column() {
        Text('åŠ©')
          .fontSize(16)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor(Constants.COLOR_PRIMARY_LIGHT)
      .justifyContent(FlexAlign.Center)
      .margin({ left: 12, right: 8 })

      // åŠ è½½åŠ¨ç”» - ç®€å•çš„ä¸‰ä¸ªç‚¹
      Row() {
        Text('â—')
          .fontSize(8)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .margin({ right: 3 })
        Text('â—')
          .fontSize(8)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .margin({ right: 3 })
        Text('â—')
          .fontSize(8)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
      }
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius(12)
      .border({ width: 1, color: Constants.COLOR_BORDER })
      .padding({ left: 14, right: 14, top: 12, bottom: 12 })
      .constraintSize({ maxWidth: '70%' })
      .margin({ right: 8 })
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
    .justifyContent(FlexAlign.Start)
  }
}

/**
 * èŠå¤©æ¶ˆæ¯æ¥å£
 */
export interface ChatMessage {
  id: number;
  content: string;
  isUser: boolean;
  timestamp: Date;
  sendStatus?: number; // å‘é€çŠ¶æ€ï¼ˆ0:å‘é€ä¸­, 1:æˆåŠŸ, 2:å¤±è´¥ï¼‰
}
