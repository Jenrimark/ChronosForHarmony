import { Constants } from '../common/Constants';
import { AuthService, UserInfo } from '../service/AuthService';
import { HolidayService } from '../service/HolidayService';
import { promptAction, UIContext } from '@kit.ArkUI';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
import auth from '@hw-agconnect/auth';

/**
 * è®¾ç½®é¡µé¢
 */
@Component
export struct Settings {
  @State appVersion: string = Constants.APP_VERSION;
  @State showClearDataDialog: boolean = false;
  @State showAboutDialog: boolean = false;
  @State userInfo: UserInfo | null = null;
  @State isLoading: boolean = false;
  @State cacheSize: string = 'è®¡ç®—ä¸­...';
  @State calendarDataSource: number = Constants.DATA_SOURCE_LOCAL; // 0=æœ¬åœ°æ•°æ®, 1=APIæ•°æ®
  @State isSwitchingDataSource: boolean = false; // åˆ‡æ¢æ•°æ®æºæ—¶çš„åŠ è½½çŠ¶æ€

  private authService: AuthService = AuthService.getInstance();
  private holidayService: HolidayService = HolidayService.getInstance();

  aboutToAppear() {
    // å¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®ä¿ AuthService å·²åˆå§‹åŒ–
    this.initAndLoadUserInfo();
    this.calculateCacheSize();
    this.loadCalendarDataSource();
  }

  /**
   * åŠ è½½æ—¥å†æ•°æ®æºè®¾ç½®
   */
  loadCalendarDataSource(): void {
    this.calendarDataSource = this.holidayService.getDataSource();
  }

  /**
   * åˆ‡æ¢æ—¥å†æ•°æ®æº
   */
  async switchCalendarDataSource(value: boolean): Promise<void> {
    const newSource = value ? Constants.DATA_SOURCE_API : Constants.DATA_SOURCE_LOCAL;
    
    if (newSource === this.calendarDataSource) {
      return; // æ²¡æœ‰å˜åŒ–ï¼Œä¸éœ€è¦åˆ‡æ¢
    }

    this.isSwitchingDataSource = true;
    
    try {
      await this.holidayService.setDataSource(newSource);
      this.calendarDataSource = newSource;
      
      const sourceName = newSource === Constants.DATA_SOURCE_LOCAL ? 'æœ¬åœ°æ•°æ®' : 'APIæ•°æ®';
      promptAction.showToast({ 
        message: `å·²åˆ‡æ¢ä¸º${sourceName}ï¼Œè¯·åˆ·æ–°æ—¥å†æŸ¥çœ‹æ•ˆæœ`,
        duration: 2000
      });
      
      hilog.info(0x0000, 'Settings', `æ—¥å†æ•°æ®æºå·²åˆ‡æ¢ä¸º: ${sourceName}`);
    } catch (error) {
      console.error('åˆ‡æ¢æ•°æ®æºå¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•' });
      // æ¢å¤åŸçŠ¶æ€
      this.calendarDataSource = this.holidayService.getDataSource();
    } finally {
      this.isSwitchingDataSource = false;
    }
  }

  /**
   * åˆå§‹åŒ–å¹¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
   */
  async initAndLoadUserInfo(): Promise<void> {
    // ç¡®ä¿ AuthService çš„ context å·²è®¾ç½®
    const context = getContext(this) as common.UIAbilityContext;
    await this.authService.setContext(context);
    await this.loadUserInfo();
  }

  /**
   * åŠ è½½ç”¨æˆ·ä¿¡æ¯
   */
  async loadUserInfo(): Promise<void> {
    // å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼ˆåŒ…å«å¤´åƒæ˜µç§°ï¼‰
    this.userInfo = this.authService.getCurrentUser();
    
    if (this.userInfo) {
      hilog.info(0x0000, 'Settings', 'ä»ç¼“å­˜åŠ è½½ç”¨æˆ·ä¿¡æ¯: %{public}s, å¤´åƒ: %{public}s', 
        this.userInfo.displayName, this.userInfo.avatarUri ? 'æœ‰' : 'æ— ');
    } else {
      // å°è¯•ä»æœåŠ¡å™¨è·å–å½“å‰ç”¨æˆ·
      try {
        this.userInfo = await this.authService.getCurrentUserAsync();
        if (this.userInfo) {
          hilog.info(0x0000, 'Settings', 'ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯: %{public}s', this.userInfo.displayName);
        }
      } catch (e) {
        hilog.warn(0x0000, 'Settings', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
      }
    }
  }

  /**
   * åä¸ºè´¦å·ç™»å½•
   */
  async handleLogin(): Promise<void> {
    this.isLoading = true;
    try {
      hilog.info(0x0000, 'Settings', 'å¼€å§‹ç™»å½•...');
      this.userInfo = await this.authService.login();
      if (this.userInfo) {
        hilog.info(0x0000, 'Settings', 'åŸºç¡€ç™»å½•æˆåŠŸï¼Œå¼€å§‹è·å–å¤´åƒæ˜µç§°...');
        // ç™»å½•æˆåŠŸåï¼Œè·å–å¤´åƒæ˜µç§°
        await this.fetchUserProfile();
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸï¼' });
        hilog.info(0x0000, 'Settings', 'ç™»å½•æˆåŠŸ');
      } else {
        promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' });
        hilog.warn(0x0000, 'Settings', 'ç™»å½•è¿”å›ç©º');
      }
    } catch (e) {
      hilog.error(0x0000, 'Settings', 'ç™»å½•å¼‚å¸¸: %{public}s', JSON.stringify(e));
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
    this.isLoading = false;
  }

  /**
   * è·å–ç”¨æˆ·å¤´åƒæ˜µç§°ï¼ˆä½¿ç”¨ Account Kitï¼‰
   */
  async fetchUserProfile(): Promise<void> {
    try {
      hilog.info(0x0000, 'Settings', 'å¼€å§‹è·å–ç”¨æˆ·å¤´åƒæ˜µç§°...');
      
      // è·å–UIContext - åœ¨ç»„ä»¶ä¸­ä½¿ç”¨this.getUIContext()
      const uiContext: UIContext = this.getUIContext();
      
      // ä½¿ç”¨ Account Kit è·å–å¤´åƒæ˜µç§°
      const success = await this.authService.fetchUserProfileWithAccountKit(uiContext);
      if (success) {
        // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ä»¥æ›´æ–°UI
        await this.loadUserInfo();
        hilog.info(0x0000, 'Settings', 'å¤´åƒæ˜µç§°è·å–æˆåŠŸ');
      } else {
        hilog.warn(0x0000, 'Settings', 'å¤´åƒæ˜µç§°è·å–å¤±è´¥');
      }
      
    } catch (error) {
      const err = error as BusinessError;
      hilog.error(0x0000, 'Settings', 'è·å–å¤´åƒæ˜µç§°å¤±è´¥: Code: %{public}s, Message: %{public}s',
        String(err.code), String(err.message));
      // è·å–å¤´åƒæ˜µç§°å¤±è´¥ä¸å½±å“ç™»å½•çŠ¶æ€ï¼Œåªæ˜¯æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
    }
  }

  /**
   * é€€å‡ºç™»å½•
   */
  async handleLogout(): Promise<void> {
    AlertDialog.show({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'é€€å‡º',
        fontColor: Constants.COLOR_DANGER,
        action: async () => {
          await this.authService.logout();
          this.userInfo = null;
          promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
        }
      }
    });
  }

  /**
   * è®¡ç®—ç¼“å­˜å¤§å°
   */
  calculateCacheSize(): void {
    // æ¨¡æ‹Ÿè®¡ç®—ç¼“å­˜
    setTimeout(() => {
      this.cacheSize = '12.5 MB';
    }, 500);
  }

  /**
   * æ¸…é™¤ç¼“å­˜
   */
  clearCache(): void {
    AlertDialog.show({
      title: 'æ¸…é™¤ç¼“å­˜',
      message: 'ç¡®å®šè¦æ¸…é™¤åº”ç”¨ç¼“å­˜å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤æ‚¨çš„æ•°æ®ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'æ¸…é™¤',
        action: () => {
          // TODO: å®é™…æ¸…é™¤ç¼“å­˜é€»è¾‘
          this.cacheSize = '0 MB';
          promptAction.showToast({ message: 'ç¼“å­˜å·²æ¸…é™¤' });
        }
      }
    });
  }

  /**
   * æ¸…é™¤æ‰€æœ‰æ•°æ®![1766826056702](image/Settings/1766826056702.png)![1766826061508](image/Settings/1766826061508.png)![1766826073260](image/Settings/1766826073260.png)![1766826078188](image/Settings/1766826078188.png)![1766826079196](image/Settings/1766826079196.png)![1766826079413](image/Settings/1766826079413.png)![1766826079591](image/Settings/1766826079591.png)![1766826079774](image/Settings/1766826079774.png)![1766826080003](image/Settings/1766826080003.png)![1766826080109](image/Settings/1766826080109.png)
   */
  clearAllData(): void {
    AlertDialog.show({
      title: 'æ¸…é™¤æ‰€æœ‰æ•°æ®',
      message: 'è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡ã€è´¦å•å’Œæ—¥ç¨‹æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: Constants.COLOR_DANGER,
        action: () => {
          // TODO: å®é™…æ¸…é™¤æ•°æ®é€»è¾‘
          promptAction.showToast({ message: 'æ‰€æœ‰æ•°æ®å·²æ¸…é™¤' });
        }
      }
    });
  }

  /**
   * æ˜¾ç¤ºå…³äºå¯¹è¯æ¡†
   */
  showAbout(): void {
    AlertDialog.show({
      title: Constants.APP_NAME,
      message: `ç‰ˆæœ¬ï¼š${this.appVersion}\n\n${Constants.APP_NAME}æ˜¯ä¸€æ¬¾é›†æ—¥å†ã€ä»»åŠ¡ç®¡ç†ã€è®°è´¦äºä¸€ä½“çš„æ—¶é—´ç®¡ç†åº”ç”¨ã€‚\n\nå¸®åŠ©æ‚¨æ›´å¥½åœ°è§„åˆ’æ—¶é—´ï¼Œæé«˜æ•ˆç‡ã€‚\n\nÂ© 2025 è¾°åºå›¢é˜Ÿ`,
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    });
  }

  /**
   * åé¦ˆå»ºè®®
   */
  showFeedback(): void {
    AlertDialog.show({
      title: 'åé¦ˆå»ºè®®',
      message: 'å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‘é€é‚®ä»¶è‡³ï¼š\n\n2303532728@qq.com\n\næˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨ï¼',
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    });
  }

  /**
   * æ•°æ®å¤‡ä»½
   */
  showDataManagement(): void {
    AlertDialog.show({
      title: 'æ•°æ®ç®¡ç†',
      message: 'ç™»å½•åä¸ºè´¦å·åï¼Œæ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚\n\næ‚¨å¯ä»¥åœ¨ä»»ä½•è®¾å¤‡ä¸Šç™»å½•åŒä¸€è´¦å·æ¥æ¢å¤æ•°æ®ã€‚',
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    });
  }

  build() {
    Scroll() {
      Column() {
        // ç”¨æˆ·ä¿¡æ¯/ç™»å½•å¡ç‰‡
        Column() {
          if (this.userInfo) {
            // å·²ç™»å½•çŠ¶æ€
            Row() {
              // å¤´åƒ
              if (this.userInfo.avatarUri && this.userInfo.avatarUri.trim().length > 0) {
                Image(this.userInfo.avatarUri)
                  .width(60)
                  .height(60)
                  .borderRadius(30)
                  .alt('ç”¨æˆ·å¤´åƒ')
                  .objectFit(ImageFit.Cover)
                  .onError(() => {
                    // å¦‚æœå¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                    hilog.warn(0x0000, 'Settings', 'å¤´åƒåŠ è½½å¤±è´¥: %{public}s', this.userInfo?.avatarUri || '');
                  })
              } else {
                // é»˜è®¤å¤´åƒï¼šæ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
                Column() {
                  Text((this.userInfo.displayName && this.userInfo.displayName.length > 0) 
                    ? this.userInfo.displayName.charAt(0).toUpperCase() 
                    : 'ç”¨')
                    .fontSize(24)
                    .fontColor('#FFFFFF')
                    .fontWeight(FontWeight.Bold)
                }
                .width(60)
                .height(60)
                .borderRadius(30)
                .backgroundColor(Constants.COLOR_PRIMARY)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              }

              // ç”¨æˆ·ä¿¡æ¯
              Column() {
                Text(this.userInfo.displayName || 'åä¸ºç”¨æˆ·')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Constants.COLOR_TEXT_PRIMARY)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                Text('åä¸ºè´¦å·å·²ç™»å½•')
                  .fontSize(14)
                  .fontColor(Constants.COLOR_TEXT_SECONDARY)
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 16 })
              .layoutWeight(1)

              // é€€å‡ºæŒ‰é’®
              Button('é€€å‡º')
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
                .backgroundColor('#F5F5F5')
                .borderRadius(16)
                .height(32)
                .padding({ left: 16, right: 16 })
                .onClick(() => this.handleLogout())
            }
            .width('100%')
            .padding(20)
            .alignItems(VerticalAlign.Center)
          } else {
            // æœªç™»å½•çŠ¶æ€
            Column() {
              Text('ğŸ”')
                .fontSize(40)
                .margin({ bottom: 12 })

              Text('ç™»å½•åä¸ºè´¦å·')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(Constants.COLOR_TEXT_PRIMARY)
                .margin({ bottom: 4 })

              Text('ç™»å½•åå¯åŒæ­¥æ•°æ®åˆ°äº‘ç«¯')
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
                .margin({ bottom: 16 })

              Button('åä¸ºè´¦å·ç™»å½•')
                .width('80%')
                .height(44)
                .fontSize(16)
                .fontColor(Color.White)
                .backgroundColor(Constants.COLOR_PRIMARY)
                .borderRadius(22)
                .enabled(!this.isLoading)
                .onClick(() => this.handleLogin())

              if (this.isLoading) {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .margin({ top: 12 })
              }
            }
            .width('100%')
            .padding(24)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          }
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .margin({ top: 16, left: 16, right: 16 })

        // è®¾ç½®é¡¹åˆ—è¡¨
        Column() {
          // æ—¥å†æ•°æ®æº
          this.buildDataSourceSwitchItem()

          Divider().color('#E5E5EA').margin({ left: 16, right: 16 })

          // æ•°æ®ç®¡ç†
          this.buildSettingItem('æ•°æ®ç®¡ç†', 'å¤‡ä»½å’Œæ¢å¤æ•°æ®', () => {
            this.showDataManagement();
          })

          Divider().color('#E5E5EA').margin({ left: 16, right: 16 })

          // æ¸…é™¤ç¼“å­˜
          this.buildSettingItem('æ¸…é™¤ç¼“å­˜', `å½“å‰ç¼“å­˜ï¼š${this.cacheSize}`, () => {
            this.clearCache();
          })

          Divider().color('#E5E5EA').margin({ left: 16, right: 16 })

          // æ¸…é™¤æ‰€æœ‰æ•°æ®
          this.buildSettingItem('æ¸…é™¤æ‰€æœ‰æ•°æ®', 'åˆ é™¤æ‰€æœ‰ä»»åŠ¡å’Œæ•°æ®', () => {
            this.clearAllData();
          }, Constants.COLOR_DANGER)
        }
        .width('100%')
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius(12)
        .margin({ top: 16, left: 16, right: 16 })

        // å…³äº
        Column() {
          this.buildSettingItem('å…³äºåº”ç”¨', `ç‰ˆæœ¬ ${this.appVersion}`, () => {
            this.showAbout();
          })

          Divider().color('#E5E5EA').margin({ left: 16, right: 16 })

          this.buildSettingItem('åé¦ˆå»ºè®®', 'å‘æˆ‘ä»¬åé¦ˆé—®é¢˜æˆ–å»ºè®®', () => {
            this.showFeedback();
          })
        }
        .width('100%')
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius(12)
        .margin({ top: 16, left: 16, right: 16, bottom: 32 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
  }

  @Builder
  buildSettingItem(title: string, subtitle: string, onClick: () => void, titleColor?: string) {
    Row() {
      Column() {
        Text(title)
          .fontSize(16)
          .fontColor(titleColor || Constants.COLOR_TEXT_PRIMARY)
        if (subtitle) {
          Text(subtitle)
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .margin({ top: 4 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('>')
        .fontSize(16)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .opacity(0.6)
    }
    .width('100%')
    .padding(16)
    .onClick(() => onClick())
  }

  @Builder
  buildDataSourceSwitchItem() {
    Row() {
      Column() {
        Text('æ—¥å†æ•°æ®æº')
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        Text(this.calendarDataSource === Constants.DATA_SOURCE_LOCAL 
          ? 'ä½¿ç”¨æœ¬åœ°æ—¥å†æ•°æ®ï¼ˆç¦»çº¿å¯ç”¨ï¼‰' 
          : 'ä½¿ç”¨APIæ—¥å†æ•°æ®ï¼ˆéœ€è¦ç½‘ç»œï¼Œæ•°æ®æ›´å‡†ç¡®ï¼‰')
          .fontSize(14)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (this.isSwitchingDataSource) {
        LoadingProgress()
          .width(20)
          .height(20)
      } else {
        Toggle({ type: ToggleType.Switch, isOn: this.calendarDataSource === Constants.DATA_SOURCE_API })
          .selectedColor(Constants.COLOR_PRIMARY)
          .switchPointColor(Color.White)
          .onChange((isOn: boolean) => {
            this.switchCalendarDataSource(isOn);
          })
      }
    }
    .width('100%')
    .padding(16)
  }
}
