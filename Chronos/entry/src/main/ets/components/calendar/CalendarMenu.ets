import { Constants } from '../../common/Constants';

/**
 * æ—¥å†å¿«æ·èœå•ç»„ä»¶
 */
@Component
export struct CalendarMenu {
  @Link isShow: boolean;
  onCreateEvent: () => void = () => {};
  onJumpToDate: () => void = () => {};
  onSearch: () => void = () => {};
  onSettings: () => void = () => {};
  onHelp: () => void = () => {};

  /**
   * æ„å»ºèœå•é¡¹
   */
  @Builder
  buildMenuItem(icon: string, label: string, onClick: () => void) {
    Row() {
      Text(icon)
        .fontSize(18)
        .width(30)
      
      Text(label)
        .fontSize(15)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 14, bottom: 14 })
    .onClick(() => {
      onClick();
      this.isShow = false;
    })
  }

  build() {
    Column() {
      this.buildMenuItem('â•', 'æ–°å»ºæ—¥ç¨‹', this.onCreateEvent)
      
      Divider()
        .color(Constants.COLOR_DIVIDER)
        .margin({ left: 46 })
      
      this.buildMenuItem('ğŸ“…', 'è·³è½¬åˆ°æŒ‡å®šæ—¥æœŸ', this.onJumpToDate)
      
      Divider()
        .color(Constants.COLOR_DIVIDER)
        .margin({ left: 46 })
      
      this.buildMenuItem('ğŸ”', 'æœç´¢æ—¥ç¨‹', this.onSearch)
      
      Divider()
        .color(Constants.COLOR_DIVIDER)
        .margin({ left: 46 })
      
      this.buildMenuItem('âš™ï¸', 'è®¾ç½®', this.onSettings)
      
      Divider()
        .color(Constants.COLOR_DIVIDER)
        .margin({ left: 46 })
      
      this.buildMenuItem('â“', 'å¸®åŠ©ä¸åé¦ˆ', this.onHelp)
    }
    .width(200)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .shadow({
      radius: 16,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
  }
}

/**
 * æ—¥æœŸè·³è½¬å¼¹çª—ç»„ä»¶
 */
@Component
export struct JumpToDateSheet {
  @Link isShow: boolean;
  @Link targetDate: Date;
  onConfirm: (date: Date) => void = () => {};

  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth();
  @State selectedDay: number = new Date().getDate();

  aboutToAppear() {
    this.selectedYear = this.targetDate.getFullYear();
    this.selectedMonth = this.targetDate.getMonth();
    this.selectedDay = this.targetDate.getDate();
  }

  /**
   * è·å–å¹´ä»½åˆ—è¡¨
   */
  getYears(): number[] {
    const years: number[] = [];
    const currentYear = new Date().getFullYear();
    for (let y = currentYear - 50; y <= currentYear + 50; y++) {
      years.push(y);
    }
    return years;
  }

  /**
   * è·å–æœˆä»½åˆ—è¡¨
   */
  getMonths(): number[] {
    const months: number[] = [];
    for (let m = 0; m < 12; m++) {
      months.push(m);
    }
    return months;
  }

  /**
   * è·å–æ—¥æœŸåˆ—è¡¨
   */
  getDays(): number[] {
    const days: number[] = [];
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      days.push(d);
    }
    return days;
  }

  /**
   * ç¡®è®¤é€‰æ‹©
   */
  confirm(): void {
    const date = new Date(this.selectedYear, this.selectedMonth, this.selectedDay);
    this.onConfirm(date);
    this.isShow = false;
  }

  build() {
    Column() {
      // å¤´éƒ¨
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.isShow = false;
          })
        
        Blank()
        
        Text('è·³è½¬åˆ°æ—¥æœŸ')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            this.confirm();
          })
      }
      .width('100%')
      .padding({ left: 8, right: 8, top: 12, bottom: 12 })

      // æ—¥æœŸé€‰æ‹©å™¨
      Row() {
        // å¹´
        TextPicker({ range: this.getYears().map(y => `${y}å¹´`), selected: this.selectedYear - (new Date().getFullYear() - 50) })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.selectedYear = new Date().getFullYear() - 50 + index;
            }
          })

        // æœˆ
        TextPicker({ range: this.getMonths().map(m => `${m + 1}æœˆ`), selected: this.selectedMonth })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.selectedMonth = index;
            }
          })

        // æ—¥
        TextPicker({ range: this.getDays().map(d => `${d}æ—¥`), selected: this.selectedDay - 1 })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.selectedDay = index + 1;
            }
          })
      }
      .width('100%')
      .height(200)
      .padding({ left: 16, right: 16 })

      // å¿«æ·æŒ‰é’®
      Row() {
        Button('ä»Šå¤©')
          .type(ButtonType.Normal)
          .backgroundColor(Constants.COLOR_PRIMARY_LIGHT)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            const today = new Date();
            this.selectedYear = today.getFullYear();
            this.selectedMonth = today.getMonth();
            this.selectedDay = today.getDate();
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 16, bottom: 32 })
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
  }
}

/**
 * æœç´¢æ—¥ç¨‹å¼¹çª—ç»„ä»¶
 */
@Component
export struct SearchEventSheet {
  @Link isShow: boolean;
  @State keyword: string = '';
  @State searchResults: SearchResultItem[] = [];
  onSearch: (keyword: string) => Promise<SearchResultItem[]> = async () => [];
  onSelectEvent: (eventId: number) => void = () => {};

  /**
   * æ‰§è¡Œæœç´¢
   */
  async doSearch(): Promise<void> {
    if (this.keyword.trim().length === 0) {
      this.searchResults = [];
      return;
    }
    this.searchResults = await this.onSearch(this.keyword);
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  formatDate(date: Date): string {
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  build() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        Text('ğŸ”')
          .fontSize(18)
          .margin({ right: 8 })
        
        TextInput({ placeholder: 'æœç´¢æ—¥ç¨‹æ ‡é¢˜æˆ–åœ°ç‚¹', text: this.keyword })
          .layoutWeight(1)
          .backgroundColor(Color.Transparent)
          .onChange((value: string) => {
            this.keyword = value;
            this.doSearch();
          })
        
        if (this.keyword.length > 0) {
          Text('âœ•')
            .fontSize(16)
            .fontColor(Constants.COLOR_TEXT_TERTIARY)
            .onClick(() => {
              this.keyword = '';
              this.searchResults = [];
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 16 })

      // æœç´¢ç»“æœ
      if (this.searchResults.length === 0 && this.keyword.length > 0) {
        Column() {
          Text('ğŸ˜”')
            .fontSize(40)
            .opacity(0.3)
          Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥ç¨‹')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
            .margin({ top: 12 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.searchResults, (item: SearchResultItem) => {
            ListItem() {
              Row() {
                Column() {
                  Text(item.title)
                    .fontSize(15)
                    .fontColor(Constants.COLOR_TEXT_PRIMARY)
                  
                  Text(this.formatDate(item.date))
                    .fontSize(12)
                    .fontColor(Constants.COLOR_TEXT_SECONDARY)
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Text('â€º')
                  .fontSize(18)
                  .fontColor(Constants.COLOR_TEXT_TERTIARY)
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .onClick(() => {
                this.onSelectEvent(item.id);
                this.isShow = false;
              })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .divider({
          strokeWidth: 1,
          color: Constants.COLOR_DIVIDER,
          startMargin: 16,
          endMargin: 16
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
  }
}

/**
 * æœç´¢ç»“æœé¡¹
 */
export class SearchResultItem {
  id: number = 0;
  title: string = '';
  date: Date = new Date();
}
