import { CalendarEvent } from '../../model/CalendarEvent';
import { MxnzpHolidayData } from '../../model/Holiday';
import { Constants } from '../../common/Constants';
import { TimelineRow } from './TimelineRow';
import { EventBlock } from './EventBlock';

/**
 * æ—¥è§†å›¾ç»„ä»¶
 * å±•ç¤ºå•æ—¥çš„è¯¦ç»†æ—¶é—´è½´è§†å›¾
 */
@Component
export struct DayView {
  @Link selectedDate: Date;
  @Prop events: CalendarEvent[] = [];
  @Prop calendarInfo: MxnzpHolidayData | null = null;
  onEventTap: (event: CalendarEvent) => void = () => {};

  private today: Date = new Date();
  private hourHeight: number = 60;

  /**
   * è·å–å½“å¤©çš„äº‹ä»¶
   */
  getTodayEvents(): CalendarEvent[] {
    return this.events.filter(event => this.isSameDay(event.startTime, this.selectedDate));
  }

  /**
   * åˆ¤æ–­æ˜¯å¦åŒä¸€å¤©
   */
  isSameDay(date1: Date, date2: Date): boolean {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä»Šå¤©
   */
  isToday(): boolean {
    return this.isSameDay(this.selectedDate, this.today);
  }

  /**
   * è·å–å½“å‰å°æ—¶
   */
  getCurrentHour(): number {
    return this.today.getHours();
  }

  /**
   * è·å–å½“å‰åˆ†é’Ÿ
   */
  getCurrentMinute(): number {
    return this.today.getMinutes();
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
   */
  formatDate(): string {
    const year = this.selectedDate.getFullYear();
    const month = this.selectedDate.getMonth() + 1;
    const day = this.selectedDate.getDate();
    return `${year}å¹´${month}æœˆ${day}æ—¥`;
  }

  /**
   * è·å–æ˜ŸæœŸå‡ 
   */
  getWeekDay(): string {
    const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    return weekDays[this.selectedDate.getDay()];
  }

  /**
   * ç”Ÿæˆ24å°æ—¶æ•°ç»„
   */
  getHours(): number[] {
    const hours: number[] = [];
    for (let i = 0; i < 24; i++) {
      hours.push(i);
    }
    return hours;
  }

  build() {
    Column() {
      // æ—¥æœŸä¿¡æ¯å¤´éƒ¨
      Column() {
        Row() {
          Column() {
            // å…¬å†æ—¥æœŸ
            Text(this.formatDate())
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Constants.COLOR_TEXT_PRIMARY)
            
            // æ˜ŸæœŸ
            Text(this.getWeekDay())
              .fontSize(14)
              .fontColor(Constants.COLOR_TEXT_SECONDARY)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          // å†œå†ä¿¡æ¯
          if (this.calendarInfo) {
            Column() {
              Text(this.calendarInfo.lunarCalendar || '')
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_PRIMARY)
              
              Row() {
                if (this.calendarInfo.yearTips) {
                  Text(`${this.calendarInfo.yearTips}å¹´`)
                    .fontSize(12)
                    .fontColor(Constants.COLOR_TEXT_SECONDARY)
                }
                if (this.calendarInfo.chineseZodiac) {
                  Text(`${this.calendarInfo.chineseZodiac}`)
                    .fontSize(12)
                    .fontColor(Constants.COLOR_TEXT_SECONDARY)
                    .margin({ left: 8 })
                }
              }
              .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.End)
          }
        }
        .width('100%')

        // èŠ‚æ°”å’Œæ˜Ÿåº§
        if (this.calendarInfo) {
          Row() {
            if (this.calendarInfo.solarTerms && this.calendarInfo.solarTerms !== 'æ— ') {
              Text(`ğŸŒ¿ ${this.calendarInfo.solarTerms}`)
                .fontSize(12)
                .fontColor(Constants.COLOR_SUCCESS)
            }
            if (this.calendarInfo.constellation) {
              Text(`â­ ${this.calendarInfo.constellation}`)
                .fontSize(12)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
                .margin({ left: 12 })
            }
          }
          .width('100%')
          .margin({ top: 8 })
        }

        // ä»Šæ—¥æ ‡è®°
        if (this.isToday()) {
          Text('ä»Šå¤©')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor(Constants.COLOR_PRIMARY)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
            .margin({ top: 8 })
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius({ bottomLeft: 16, bottomRight: 16 })

      // æ—¶é—´è½´æ»šåŠ¨åŒºåŸŸ
      Scroll() {
        Stack() {
          // æ—¶é—´åˆ»åº¦è¡Œ
          Column() {
            ForEach(this.getHours(), (hour: number) => {
              TimelineRow({
                hour: hour,
                showCurrentTimeLine: this.isToday() && hour === this.getCurrentHour(),
                currentMinute: this.getCurrentMinute()
              })
            })
            // åº•éƒ¨ç•™ç™½ç»™å¯¼èˆªæ 
            Row()
              .width('100%')
              .height(80)
          }
          .width('100%')

          // äº‹ä»¶å—
          ForEach(this.getTodayEvents(), (event: CalendarEvent) => {
            EventBlock({
              event: event,
              hourHeight: this.hourHeight,
              onEventTap: this.onEventTap
            })
          })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
  }
}
