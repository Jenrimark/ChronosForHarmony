import { CalendarEvent, ReminderType, RepeatRule, getReminderTypeText, getRepeatRuleText } from '../../model/CalendarEvent';
import { SmartParser, ParseResult } from '../../utils/SmartParser';
import { Constants } from '../../common/Constants';

/**
 * æ—¥ç¨‹åˆ›å»º/ç¼–è¾‘å¼¹çª—ç»„ä»¶
 */
@Component
export struct EventSheet {
  @Link isShow: boolean;
  @Prop editEvent: CalendarEvent | null = null;
  @Link selectedDate: Date;
  onSave: (event: CalendarEvent) => void = () => {};
  onDelete: (event: CalendarEvent) => void = () => {};

  @State title: string = '';
  @State location: string = '';
  @State isAllDay: boolean = false;
  @State startTime: Date = new Date();
  @State endTime: Date = new Date();
  @State reminderType: ReminderType = ReminderType.TEN_MIN;
  @State repeatRule: RepeatRule = RepeatRule.NONE;
  @State isImportant: boolean = false;
  @State smartInput: string = '';
  @State showTimePicker: boolean = false;
  @State isEditingStart: boolean = true;
  @State showReminderPicker: boolean = false;
  @State showRepeatPicker: boolean = false;

  private smartParser: SmartParser = SmartParser.getInstance();
  private isEditMode: boolean = false;

  aboutToAppear() {
    this.isEditMode = this.editEvent !== null;
    if (this.isEditMode && this.editEvent) {
      this.loadEventData(this.editEvent);
    } else {
      this.initNewEvent();
    }
  }

  /**
   * åŠ è½½ç¼–è¾‘äº‹ä»¶æ•°æ®
   */
  loadEventData(event: CalendarEvent): void {
    this.title = event.title;
    this.location = event.location;
    this.isAllDay = event.isAllDay;
    this.startTime = new Date(event.startTime);
    this.endTime = new Date(event.endTime);
    this.reminderType = event.reminder;
    this.repeatRule = event.repeatRule;
    this.isImportant = event.priority;
  }

  /**
   * åˆå§‹åŒ–æ–°äº‹ä»¶
   */
  initNewEvent(): void {
    const now = new Date();
    // ä½¿ç”¨é€‰ä¸­æ—¥æœŸ
    this.startTime = new Date(
      this.selectedDate.getFullYear(),
      this.selectedDate.getMonth(),
      this.selectedDate.getDate(),
      now.getHours() + 1,
      0, 0
    );
    this.endTime = new Date(this.startTime);
    this.endTime.setHours(this.startTime.getHours() + 1);
  }

  /**
   * æ™ºèƒ½è§£æè¾“å…¥
   */
  onSmartInputChange(value: string): void {
    this.smartInput = value;
    if (value.length > 0) {
      const result = this.smartParser.parse(value);
      this.applyParseResult(result);
    }
  }

  /**
   * åº”ç”¨è§£æç»“æœ
   */
  applyParseResult(result: ParseResult): void {
    if (result.title.length > 0) {
      this.title = result.title;
    }
    if (result.hasDate && result.date) {
      this.startTime = new Date(
        result.date.getFullYear(),
        result.date.getMonth(),
        result.date.getDate(),
        this.startTime.getHours(),
        this.startTime.getMinutes()
      );
      this.endTime = new Date(this.startTime);
      this.endTime.setHours(this.startTime.getHours() + 1);
    }
    if (result.hasTime && result.time) {
      this.startTime.setHours(result.time.getHours());
      this.startTime.setMinutes(result.time.getMinutes());
      this.endTime = new Date(this.startTime);
      this.endTime.setHours(this.startTime.getHours() + 1);
    }
    if (result.location.length > 0) {
      this.location = result.location;
    }
    this.isAllDay = result.isAllDay;
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
   */
  formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${year}å¹´${month}æœˆ${day}æ—¥`;
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  formatTime(date: Date): string {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const h = hours < 10 ? `0${hours}` : `${hours}`;
    const m = minutes < 10 ? `0${minutes}` : `${minutes}`;
    return `${h}:${m}`;
  }

  /**
   * éªŒè¯è¡¨å•
   */
  validateForm(): boolean {
    if (this.title.trim().length === 0) {
      return false;
    }
    return true;
  }

  /**
   * ä¿å­˜äº‹ä»¶
   */
  saveEvent(): void {
    if (!this.validateForm()) {
      return;
    }

    const event = this.isEditMode && this.editEvent ? this.editEvent : new CalendarEvent();
    event.title = this.title.trim();
    event.location = this.location.trim();
    event.isAllDay = this.isAllDay;
    event.startTime = new Date(this.startTime);
    event.endTime = new Date(this.endTime);
    event.reminder = this.reminderType;
    event.repeatRule = this.repeatRule;
    event.priority = this.isImportant;

    this.onSave(event);
    this.isShow = false;
  }

  /**
   * åˆ é™¤äº‹ä»¶
   */
  deleteEvent(): void {
    if (this.editEvent) {
      this.onDelete(this.editEvent);
      this.isShow = false;
    }
  }

  /**
   * æ„å»ºè¾“å…¥è¡Œ
   */
  @Builder
  buildInputRow(icon: string, placeholder: string, value: string, onChange: (val: string) => void) {
    Row() {
      Text(icon)
        .fontSize(18)
        .width(30)
      
      TextInput({ placeholder: placeholder, text: value })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .onChange(onChange)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(8)
    .margin({ bottom: 8 })
  }

  /**
   * æ„å»ºå¼€å…³è¡Œ
   */
  @Builder
  buildToggleRow(icon: string, label: string, isOn: boolean, onToggle: (val: boolean) => void) {
    Row() {
      Text(icon)
        .fontSize(18)
        .width(30)
      
      Text(label)
        .fontSize(15)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .layoutWeight(1)
      
      Toggle({ type: ToggleType.Switch, isOn: isOn })
        .onChange(onToggle)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(8)
    .margin({ bottom: 8 })
  }

  /**
   * æ„å»ºé€‰æ‹©è¡Œ
   */
  @Builder
  buildSelectRow(icon: string, label: string, value: string, onClick: () => void) {
    Row() {
      Text(icon)
        .fontSize(18)
        .width(30)
      
      Text(label)
        .fontSize(15)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .layoutWeight(1)
      
      Text(value)
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
      
      Text('â€º')
        .fontSize(18)
        .fontColor(Constants.COLOR_TEXT_TERTIARY)
        .margin({ left: 8 })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(8)
    .margin({ bottom: 8 })
    .onClick(onClick)
  }

  build() {
    Column() {
      // å¤´éƒ¨
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.isShow = false;
          })
        
        Blank()
        
        Text(this.isEditMode ? 'ç¼–è¾‘æ—¥ç¨‹' : 'æ–°å»ºæ—¥ç¨‹')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ä¿å­˜')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(this.validateForm() ? Constants.COLOR_PRIMARY : Constants.COLOR_TEXT_TERTIARY)
          .onClick(() => {
            this.saveEvent();
          })
      }
      .width('100%')
      .padding({ left: 8, right: 8, top: 12, bottom: 12 })

      Scroll() {
        Column() {
          // æ™ºèƒ½è¾“å…¥
          Row() {
            Text('âœ¨')
              .fontSize(18)
              .width(30)
            
            TextInput({ placeholder: 'ä¸€å¥è¯æ™ºèƒ½åˆ›å»ºæ—¥ç¨‹', text: this.smartInput })
              .layoutWeight(1)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.onSmartInputChange(value);
              })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor('#FFF8F5')
          .borderRadius(8)
          .margin({ bottom: 16 })

          // æ ‡é¢˜
          this.buildInputRow('ğŸ“', 'æ—¥ç¨‹æ ‡é¢˜', this.title, (val: string) => {
            this.title = val;
          })

          // åœ°ç‚¹
          this.buildInputRow('ğŸ“', 'æ·»åŠ åœ°ç‚¹', this.location, (val: string) => {
            this.location = val;
          })

          // å…¨å¤©å¼€å…³
          this.buildToggleRow('ğŸŒ…', 'å…¨å¤©', this.isAllDay, (val: boolean) => {
            this.isAllDay = val;
          })

          // å¼€å§‹æ—¶é—´
          this.buildSelectRow('ğŸ•', 'å¼€å§‹', 
            this.isAllDay ? this.formatDate(this.startTime) : `${this.formatDate(this.startTime)} ${this.formatTime(this.startTime)}`,
            () => {
              this.isEditingStart = true;
              this.showTimePicker = true;
            })

          // ç»“æŸæ—¶é—´
          this.buildSelectRow('ğŸ•‘', 'ç»“æŸ',
            this.isAllDay ? this.formatDate(this.endTime) : `${this.formatDate(this.endTime)} ${this.formatTime(this.endTime)}`,
            () => {
              this.isEditingStart = false;
              this.showTimePicker = true;
            })

          // æé†’
          this.buildSelectRow('ğŸ””', 'æé†’', getReminderTypeText(this.reminderType), () => {
            this.showReminderPicker = true;
          })

          // é‡å¤
          this.buildSelectRow('ğŸ”„', 'é‡å¤', getRepeatRuleText(this.repeatRule), () => {
            this.showRepeatPicker = true;
          })

          // é‡è¦æ ‡è®°
          this.buildToggleRow('â­', 'é‡è¦', this.isImportant, (val: boolean) => {
            this.isImportant = val;
          })

          // åˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
          if (this.isEditMode) {
            Button('åˆ é™¤æ—¥ç¨‹')
              .type(ButtonType.Normal)
              .width('100%')
              .height(44)
              .backgroundColor('#FFF0F0')
              .fontColor(Constants.COLOR_DANGER)
              .margin({ top: 24 })
              .onClick(() => {
                this.deleteEvent();
              })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 32 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.COLOR_BACKGROUND)
  }
}
