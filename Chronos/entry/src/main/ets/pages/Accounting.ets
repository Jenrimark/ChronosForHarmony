import { BillItem } from '../components/BillItem';
import { BillService } from '../service/BillService';
import { Bill, BillType, BillCategory } from '../model/Bill';
import { Constants } from '../common/Constants';
import { Utils } from '../common/Utils';
import { MimoAIService, BillRecognitionResult } from '../service/MimoAIService';
import { AudioRecorderService } from '../service/AudioRecorderService';
import { SpeechRecognitionService } from '../service/SpeechRecognitionService';
import { ManualBillSheet } from '../components/ManualBillSheet';
import { BillStatistics } from '../components/BillStatistics';
import { promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { preferences } from '@kit.ArkData';

/**
 * è´¦å•åˆ†ç»„æ¥å£
 */
interface BillGroup {
  date: string;
  bills: Bill[];
}

/**
 * AIè®°è´¦é¡µé¢ - å‚è€ƒæˆªå›¾è®¾è®¡
 */
@Component
export struct Accounting {
  @State bills: Bill[] = [];
  @State todayBills: Bill[] = [];
  @State todayIncome: number = 0;
  @State todayExpense: number = 0;
  @State monthExpense: number = 0;
  @State monthIncome: number = 0;
  @State monthBalance: number = 0;
  
  // è¾“å…¥æ ç›¸å…³çŠ¶æ€
  @State showInputBar: boolean = false;
  @State inputText: string = '';
  @State isRecording: boolean = false;
  @State isProcessing: boolean = false;
  @State recordingDuration: number = 0; // å½•éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰
  @State recordingTimer: number = 0; // å½•éŸ³è®¡æ—¶å™¨ID
  @State isLongPressing: boolean = false; // æ˜¯å¦æ­£åœ¨é•¿æŒ‰
  private longPressTimer: number = 0; // é•¿æŒ‰è®¡æ—¶å™¨ID
  
  // è´¦å•è¯¦æƒ…
  @State selectedBill: Bill | null = null;
  @State showBillDetail: boolean = false;
  
  // å†å²è´¦å•åˆ†ç»„æ•°æ®
  @State historyBillGroups: BillGroup[] = [];
  
  // æ‰‹åŠ¨è®°è´¦å¼¹çª—
  @State showManualBillSheet: boolean = false;
  
  // æœˆé¢„ç®—ç›¸å…³çŠ¶æ€
  @State monthBudget: number = 0;
  @State showBudgetDialog: boolean = false;
  @State budgetInputText: string = '';
  private readonly BUDGET_KEY: string = 'month_budget';
  
  // ç»Ÿè®¡é¡µé¢çŠ¶æ€
  @State showStatistics: boolean = false;  private billService: BillService = BillService.getInstance();
  private aiService: MimoAIService = MimoAIService.getInstance();
  private audioRecorderService: AudioRecorderService = AudioRecorderService.getInstance();
  private speechRecognitionService: SpeechRecognitionService = SpeechRecognitionService.getInstance();

  aboutToAppear() {
    this.loadBills();
    this.loadStatistics();
    this.loadBudget();
    // è®¾ç½®MIMO API Keyï¼ˆä»é…ç½®ä¸­è¯»å–ï¼‰
    // TODO: ä»é…ç½®æ–‡ä»¶æˆ–ç”¨æˆ·è®¾ç½®ä¸­è¯»å–API Key
    const apiKey = Constants.MIMO_API_KEY;
    if (apiKey && apiKey.length > 0) {
      this.aiService.setApiKey(apiKey);
    }
    // è®¾ç½®å½•éŸ³æœåŠ¡çš„ä¸Šä¸‹æ–‡
    // æ³¨æ„ï¼šgetContextå·²åºŸå¼ƒï¼Œè¿™é‡Œæš‚æ—¶ä¸è®¾ç½®context
    // åç»­å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å–contextï¼Œæˆ–è€…ä¿®æ”¹AudioRecorderServiceä¸éœ€è¦context
    // this.audioRecorderService.setContext(context);
  }

  /**
   * åŠ è½½æœˆé¢„ç®—
   */
  async loadBudget(): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const store = await preferences.getPreferences(context, 'accounting_prefs');
      const budget = await store.get(this.BUDGET_KEY, 0);
      this.monthBudget = budget as number;
    } catch (error) {
      console.error('åŠ è½½é¢„ç®—å¤±è´¥:', error);
      this.monthBudget = 0;
    }
  }

  /**
   * ä¿å­˜æœˆé¢„ç®—
   */
  async saveBudget(budget: number): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const store = await preferences.getPreferences(context, 'accounting_prefs');
      await store.put(this.BUDGET_KEY, budget);
      await store.flush();
      this.monthBudget = budget;
      promptAction.showToast({ message: 'é¢„ç®—è®¾ç½®æˆåŠŸ' });
    } catch (error) {
      console.error('ä¿å­˜é¢„ç®—å¤±è´¥:', error);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  /**
   * è·å–é¢„ç®—ä½¿ç”¨ç™¾åˆ†æ¯”
   */
  getBudgetPercentage(): number {
    if (this.monthBudget <= 0) {
      return 0;
    }
    const percentage = (this.monthExpense / this.monthBudget) * 100;
    return Math.min(percentage, 100);
  }

  /**
   * è·å–é¢„ç®—å‰©ä½™é‡‘é¢
   */
  getBudgetRemaining(): number {
    return Math.max(this.monthBudget - this.monthExpense, 0);
  }

  /**
   * åŠ è½½è´¦å•
   */
  async loadBills(): Promise<void> {
    const allBills = await this.billService.getAllBills();
    this.bills = [...allBills];
    
    // ç­›é€‰ä»Šå¤©çš„è´¦å•
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    this.todayBills = allBills.filter(bill => {
      const billDate = new Date(bill.date);
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() === today.getTime();
    });
    
    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    this.todayBills.sort((a: Bill, b: Bill): number => {
      return b.createTime.getTime() - a.createTime.getTime();
    });
    
    // åŠ è½½å†å²è´¦å•åˆ†ç»„
    const historyBills = allBills.filter(bill => {
      const billDate = new Date(bill.date);
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() < today.getTime();
    });
    this.historyBillGroups = this.groupBillsByDate(historyBills);
  }

  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  async loadStatistics(): Promise<void> {
    const todayBills = await this.billService.getTodayBills();
    const monthBills = await this.billService.getMonthBills();
    
    this.todayIncome = this.billService.calculateIncome(todayBills);
    this.todayExpense = this.billService.calculateExpense(todayBills);
    this.monthIncome = this.billService.calculateIncome(monthBills);
    this.monthExpense = this.billService.calculateExpense(monthBills);
    this.monthBalance = this.monthIncome - this.monthExpense;
  }

  /**
   * ç‚¹å‡»åŠ å· - å±•å¼€è¾“å…¥æ 
   */
  onAddButtonClick(): void {
    this.showInputBar = true;
    this.inputText = '';
  }

  /**
   * é•¿æŒ‰åŠ å· - å¼€å§‹å½•éŸ³æ¨¡å¼
   */
  async onAddButtonLongPress(): Promise<void> {
    try {
      // æ£€æŸ¥æƒé™
      const hasPermission = await this.audioRecorderService.checkPermission();
      if (!hasPermission) {
        console.error('æ²¡æœ‰éº¦å…‹é£æƒé™');
        // TODO: æ˜¾ç¤ºæƒé™è¯·æ±‚æç¤º
        return;
      }

      // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“
      try {
        await this.speechRecognitionService.initEngine();
      } catch (error) {
        console.error('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“å¤±è´¥:', error);
        // å³ä½¿è¯†åˆ«å¼•æ“åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿç»§ç»­å½•éŸ³æµç¨‹
      }

      // å¼€å§‹å½•éŸ³
      await this.audioRecorderService.startRecording();
    this.isRecording = true;
    this.showInputBar = true;
      this.recordingDuration = 0;
      
      // å¼€å§‹è¯­éŸ³è¯†åˆ«
      try {
        await this.speechRecognitionService.startRecognition(
          (text: string) => {
            // å®æ—¶æ›´æ–°è¯†åˆ«ç»“æœï¼ˆä¸­é—´ç»“æœï¼‰
            if (text && text.trim()) {
              this.inputText = text;
            }
          },
          (error: Error) => {
            console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', error);
          }
        );
      } catch (error) {
        console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
        // å³ä½¿è¯†åˆ«å¯åŠ¨å¤±è´¥ï¼Œä¹Ÿç»§ç»­å½•éŸ³æµç¨‹
      }
      
      // å¼€å§‹è®¡æ—¶
      this.startRecordingTimer();
      
      console.info('å¼€å§‹å½•éŸ³å’Œè¯­éŸ³è¯†åˆ«...');
    } catch (error) {
      console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', error);
      this.isRecording = false;
    }
  }

  /**
   * å¼€å§‹å½•éŸ³è®¡æ—¶
   */
  startRecordingTimer(): void {
    const timerId = setInterval(() => {
      this.recordingDuration++;
    }, 1000);
    // å°†timer IDå­˜å‚¨ä¸ºnumberç±»å‹
    this.recordingTimer = timerId as number;
  }

  /**
   * åœæ­¢å½•éŸ³è®¡æ—¶
   */
  stopRecordingTimer(): void {
    if (this.recordingTimer) {
      clearInterval(this.recordingTimer);
      this.recordingTimer = 0;
    }
  }

  /**
   * åœæ­¢å½•éŸ³å¹¶è¯†åˆ«
   */
  async stopRecording(): Promise<void> {
    try {
      // åœæ­¢å½•éŸ³
      const filePath = await this.audioRecorderService.stopRecording();
      this.isRecording = false;
      this.stopRecordingTimer();
      
      console.info('åœæ­¢å½•éŸ³ï¼Œæ–‡ä»¶è·¯å¾„:', filePath);
      
      // ç»“æŸè¯­éŸ³è¯†åˆ«å¹¶è·å–ç»“æœ
      let recognitionText = '';
      try {
        recognitionText = await this.speechRecognitionService.finishRecognition();
        console.info('è¯­éŸ³è¯†åˆ«ç»“æœ:', recognitionText);
      } catch (error) {
        console.error('è·å–è¯­éŸ³è¯†åˆ«ç»“æœå¤±è´¥:', error);
      }
      
      // å¦‚æœè¯†åˆ«ç»“æœä¸ºç©ºï¼Œä½¿ç”¨æ—¶é•¿ä½œä¸ºæç¤º
      if (!recognitionText || !recognitionText.trim()) {
        this.inputText = 'å½•éŸ³å†…å®¹ï¼š' + this.formatDuration(this.recordingDuration);
      } else {
        this.inputText = recognitionText;
      }
      
      // è‡ªåŠ¨å‘é€è¯†åˆ«
      await this.onSendInput();
      
      this.recordingDuration = 0;
    } catch (error) {
      console.error('åœæ­¢å½•éŸ³å¤±è´¥:', error);
      this.isRecording = false;
      this.stopRecordingTimer();
      
      // ç¡®ä¿å–æ¶ˆè¯­éŸ³è¯†åˆ«
      try {
        await this.speechRecognitionService.cancelRecognition();
      } catch (err) {
        console.error('å–æ¶ˆè¯­éŸ³è¯†åˆ«å¤±è´¥:', err);
      }
    }
  }

  /**
   * å–æ¶ˆå½•éŸ³
   */
  async cancelRecording(): Promise<void> {
    try {
      await this.audioRecorderService.cancelRecording();
      
      // å–æ¶ˆè¯­éŸ³è¯†åˆ«
      try {
        await this.speechRecognitionService.cancelRecognition();
      } catch (error) {
        console.error('å–æ¶ˆè¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
      }
      
      this.isRecording = false;
      this.stopRecordingTimer();
      this.recordingDuration = 0;
      this.showInputBar = false;
      console.info('å–æ¶ˆå½•éŸ³');
    } catch (error) {
      console.error('å–æ¶ˆå½•éŸ³å¤±è´¥:', error);
    }
  }

  /**
   * æ ¼å¼åŒ–å½•éŸ³æ—¶é•¿
   */
  formatDuration(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  /**
   * å‘é€è¾“å…¥æ–‡æœ¬åˆ°AIè¯†åˆ«
   */
  async onSendInput(): Promise<void> {
    if (!this.inputText.trim()) {
      return;
    }

    this.isProcessing = true;
    
    try {
      // è°ƒç”¨MIMO AIè¯†åˆ«è´¦å•
      const result: BillRecognitionResult = await this.aiService.recognizeBill(this.inputText);
      
      // åˆ›å»ºè´¦å•
      const bill = new Bill();
      bill.type = result.type;
      bill.category = result.category;
      bill.amount = result.amount || 0;
      bill.description = result.description || this.inputText;
      bill.date = new Date();
      
      // ä¿å­˜è´¦å•
      await this.billService.createBill(bill);
      
      // åˆ·æ–°æ•°æ®
      await this.loadBills();
      await this.loadStatistics();
      
      // æ¸…ç©ºè¾“å…¥
      this.inputText = '';
      this.showInputBar = false;
    } catch (error) {
      console.error('AIè¯†åˆ«å¤±è´¥:', error);
      // TODO: æ˜¾ç¤ºé”™è¯¯æç¤º
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å…³é—­è¾“å…¥æ 
   */
  async onCloseInputBar(): Promise<void> {
    // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œå…ˆå–æ¶ˆå½•éŸ³
    if (this.isRecording) {
      await this.cancelRecording();
    }
    this.showInputBar = false;
    this.inputText = '';
    this.isRecording = false;
    this.stopRecordingTimer();
    this.recordingDuration = 0;
  }

  /**
   * ç‚¹å‡»è´¦å•æŸ¥çœ‹è¯¦æƒ…
   */
  onBillTap(bill: Bill): void {
    this.selectedBill = bill;
    this.showBillDetail = true;
  }

  /**
   * åˆ é™¤è´¦å•
   */
  async onBillDelete(bill: Bill): Promise<void> {
    try {
      AlertDialog.show({
        title: 'ç¡®è®¤åˆ é™¤',
        message: `ç¡®å®šè¦åˆ é™¤è¿™ç¬”${bill.isIncome() ? 'æ”¶å…¥' : 'æ”¯å‡º'}è®°å½•å—ï¼Ÿ`,
        primaryButton: {
          value: 'å–æ¶ˆ',
          action: () => {}
        },
        secondaryButton: {
          value: 'åˆ é™¤',
          fontColor: Constants.COLOR_DANGER,
          action: async () => {
            try {
              await this.billService.deleteBill(bill);
              promptAction.showToast({ message: 'è´¦å•å·²åˆ é™¤' });
              await this.loadBills();
              await this.loadStatistics();
            } catch (error) {
              console.error('åˆ é™¤è´¦å•å¤±è´¥:', error);
              promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•' });
            }
          }
        }
      });
    } catch (error) {
      console.error('åˆ é™¤è´¦å•å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  /**
   * æ‰‹åŠ¨è®°è´¦ä¿å­˜å›è°ƒ
   */
  async onManualBillSave(bill: Bill): Promise<void> {
    try {
      await this.billService.createBill(bill);
      await this.loadBills();
      await this.loadStatistics();
      promptAction.showToast({ message: 'è´¦å•å·²ä¿å­˜' });
    } catch (error) {
      console.error('ä¿å­˜è´¦å•å¤±è´¥:', error);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  build() {
    Stack() {
      // ç»Ÿè®¡é¡µé¢ï¼ˆå…¨å±è¦†ç›–ï¼‰
      if (this.showStatistics) {
        BillStatistics({
          isShow: $showStatistics
        })
      } else {
        Column() {
          // é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
          this.buildSummaryCard()
          
          // ä»Šå¤©çš„è´¦å•åˆ—è¡¨
          this.buildTodayBillsList()
          
          // å†å²è´¦å•åˆ—è¡¨
          this.buildHistoryBillsList()
        }
        .width('100%')
        .flexGrow(1)
        .backgroundColor(Constants.COLOR_BACKGROUND)

        // å³ä¸‹è§’åŠ å·æŒ‰é’®
        this.buildAddButton()

        // è¾“å…¥æ é®ç½©å±‚å’Œè¾“å…¥æ ï¼ˆç‚¹å‡»åŠ å·æ—¶æ˜¾ç¤ºï¼‰
        if (this.showInputBar) {
          // åŠé€æ˜é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('#000000')
            .opacity(0.3)
            .onClick(() => {
              this.onCloseInputBar();
            })

          // è¾“å…¥æ 
          this.buildInputBar()
        }

        // è´¦å•è¯¦æƒ…å¼¹çª—
        if (this.showBillDetail && this.selectedBill) {
          this.buildBillDetail()
        }
        
        // æ‰‹åŠ¨è®°è´¦å¼¹çª—
        if (this.showManualBillSheet) {
          ManualBillSheet({
            isShow: $showManualBillSheet,
            onSave: async (bill: Bill) => {
              await this.onManualBillSave(bill);
            }
          })
        }
        
        // é¢„ç®—è®¾ç½®å¼¹çª—
        if (this.showBudgetDialog) {
          this.buildBudgetDialog()
        }
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºé¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  buildSummaryCard() {
    Column() {
      // æœˆä»½æ”¯å‡ºæ ‡é¢˜ï¼ˆåŠ¨æ€æ˜¾ç¤ºå½“å‰æœˆä»½ï¼‰
      Row() {
        Text(`${new Date().getMonth() + 1}æœˆæ”¯å‡º`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Row() {
          Text('ğŸ“Š')
            .fontSize(18)
          Text('ç»Ÿè®¡')
            .fontSize(14)
            .fontColor(Constants.COLOR_PRIMARY)
            .margin({ left: 4 })
        }
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .backgroundColor('rgba(255, 107, 53, 0.1)')
        .borderRadius(16)
        .onClick(() => {
          this.showStatistics = true;
        })
      }
      .width('100%')
      .margin({ bottom: 16 })

      // æ”¯å‡ºé‡‘é¢
      Text(`Â¥${this.monthExpense.toFixed(2)}`)
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .margin({ bottom: 16 })

      // æ”¶å…¥å’Œç»“ä½™
      Row() {
        Column() {
          Text('æ”¶å…¥')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
          Text(`Â¥${this.monthIncome.toFixed(2)}`)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Constants.COLOR_SUCCESS)
            .margin({ top: 6 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Column() {
          Text('ç»“ä½™')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
          Text(`Â¥${this.monthBalance.toFixed(2)}`)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Constants.COLOR_PRIMARY)
            .margin({ top: 6 })
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .margin({ bottom: 20 })

      // æœˆé¢„ç®—è¿›åº¦æ¡ï¼ˆå¯ç‚¹å‡»è®¾ç½®ï¼‰
      Column() {
        Row() {
          if (this.monthBudget > 0) {
            Text(`æœˆé¢„ç®—${this.getBudgetPercentage().toFixed(0)}%`)
              .fontSize(13)
              .fontColor(Constants.COLOR_TEXT_SECONDARY)
          } else {
            Text('ç‚¹å‡»è®¾ç½®æœˆé¢„ç®—')
              .fontSize(13)
              .fontColor(Constants.COLOR_PRIMARY)
          }
          
          Blank()
          
          if (this.monthBudget > 0) {
            Text(`å‰©ä½™ Â¥${this.getBudgetRemaining().toFixed(2)}`)
              .fontSize(13)
              .fontColor(this.getBudgetRemaining() > 0 ? Constants.COLOR_TEXT_SECONDARY : Constants.COLOR_DANGER)
          } else {
            Text('âš™ï¸')
              .fontSize(14)
          }
        }
        .width('100%')
        .margin({ bottom: 10 })

        // è¿›åº¦æ¡ï¼ˆä½¿ç”¨Rowæ¨¡æ‹Ÿï¼‰
        Row() {
          Row()
            .width(`${this.monthBudget > 0 ? this.getBudgetPercentage() : 0}%`)
            .height(8)
            .backgroundColor(this.getBudgetPercentage() >= 100 ? Constants.COLOR_DANGER : Constants.COLOR_PRIMARY)
            .borderRadius(4)
        }
        .width('100%')
        .height(8)
        .backgroundColor(Constants.COLOR_BORDER)
        .borderRadius(4)
      }
      .onClick(() => {
        this.budgetInputText = this.monthBudget > 0 ? this.monthBudget.toString() : '';
        this.showBudgetDialog = true;
      })
    }
    .width('100%')
    .padding(24)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(16)
    .margin({ top: 16, left: 16, right: 16, bottom: 12 })
    .shadow({
      radius: 12,
      color: 'rgba(0, 0, 0, 0.06)',
      offsetX: 0,
      offsetY: 4
    })
  }

  /**
   * æ„å»ºä»Šå¤©çš„è´¦å•åˆ—è¡¨
   */
  @Builder
  buildTodayBillsList() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text(`ä»Šå¤© ${Utils.formatDate(new Date(), 'MMæœˆDDæ—¥')} (${this.getWeekDay()})`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Text('>')
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // ä»Šæ—¥ç»Ÿè®¡
      Text(`æ”¯å‡ºÂ¥${this.todayExpense.toFixed(2)} | æ”¶å…¥Â¥${this.todayIncome.toFixed(2)}`)
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .padding({ left: 16, right: 16, bottom: 12 })

      // è´¦å•åˆ—è¡¨
      if (this.todayBills.length === 0) {
        Column() {
          Text('ä»Šå¤©è¿˜æ²¡æœ‰è´¦å•')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
        }
        .width('100%')
        .padding(20)
      } else {
        List() {
          ForEach(this.todayBills, (bill: Bill) => {
            ListItem() {
              this.buildBillItemContent(bill)
            }
            .swipeAction({
              end: this.buildSwipeDeleteButton(bill)
            })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 12 })
  }

  /**
   * æ„å»ºå·¦æ»‘åˆ é™¤æŒ‰é’®
   */
  @Builder
  buildSwipeDeleteButton(bill: Bill) {
    Row() {
      Button('åˆ é™¤')
        .type(ButtonType.Normal)
        .width(80)
        .height('100%')
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
        .backgroundColor(Constants.COLOR_DANGER)
        .borderRadius({ topRight: 12, bottomRight: 12 })
        .onClick(() => {
          this.onBillDelete(bill);
        })
    }
    .height('100%')
    .justifyContent(FlexAlign.End)
  }

  /**
   * æ„å»ºå†å²è´¦å•åˆ—è¡¨
   */
  @Builder
  buildHistoryBillsList() {
    if (this.historyBillGroups.length > 0) {
      Column() {
        ForEach(this.historyBillGroups, (group: BillGroup) => {
          Column() {
            // æ—¥æœŸæ ‡é¢˜
            Row() {
              Text(group.date)
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
              
              Blank()
              
              Text('>')
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 8 })

            // è¯¥æ—¥æœŸçš„è´¦å•
            List() {
              ForEach(group.bills, (bill: Bill) => {
                ListItem() {
                  this.buildBillItemContent(bill)
                }
                .swipeAction({
                  end: this.buildSwipeDeleteButton(bill)
                })
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 8 })
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 12 })
        })
      }
      .width('100%')
    }
  }

  /**
   * æ„å»ºå•ä¸ªè´¦å•é¡¹å†…å®¹
   */
  @Builder
  buildBillItemContent(bill: Bill) {
    Row() {
      // æ—¶é—´
      Text(Utils.formatDate(bill.date, 'HH:mm'))
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .width(50)

      // åˆ†ç±»å›¾æ ‡å’Œåç§°
      Row() {
        // å›¾æ ‡èƒŒæ™¯åœ†
        Column() {
          Text(this.getCategoryIcon(bill.category))
            .fontSize(18)
        }
        .width(36)
        .height(36)
        .backgroundColor(bill.isIncome() ? 'rgba(255, 167, 38, 0.15)' : 'rgba(255, 107, 53, 0.1)')
        .borderRadius(18)
        .justifyContent(FlexAlign.Center)
        
        Text(this.getCategoryName(bill.category))
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .margin({ left: 10 })
      }
      .layoutWeight(1)
      .margin({ left: 12 })

      // é‡‘é¢
      Text(bill.getDisplayAmount())
        .fontSize(17)
        .fontWeight(FontWeight.Bold)
        .fontColor(
          bill.isIncome() ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER
        )
    }
    .width('100%')
    .padding({ top: 14, bottom: 14, left: 12, right: 12 })
    .backgroundColor(Constants.COLOR_BACKGROUND)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .onClick(() => {
      this.onBillTap(bill);
    })
  }

  /**
   * æ„å»ºå•ä¸ªè´¦å•é¡¹ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
   */
  @Builder
  buildBillItem(bill: Bill) {
    this.buildBillItemContent(bill)
  }

  /**
   * æ„å»ºåŠ å·æŒ‰é’®
   */
  @Builder
  buildAddButton() {
    Column() {
      // æ‰‹åŠ¨è®°è´¦æŒ‰é’®ï¼ˆåœ¨åŠ å·æŒ‰é’®ä¸Šæ–¹ï¼‰
      Button('ğŸ“')
        .type(ButtonType.Circle)
        .width(48)
        .height(48)
        .fontSize(22)
        .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
        .backgroundColor(Constants.COLOR_SUCCESS)
        .shadow({
          radius: 8,
          color: 'rgba(255, 167, 38, 0.4)',
          offsetX: 0,
          offsetY: 2
        })
        .margin({ bottom: 12 })
        .onClick(() => {
          this.showManualBillSheet = true;
        })

      // AIè®°è´¦æŒ‰é’®
      Button('+')
        .type(ButtonType.Circle)
        .width(60)
        .height(60)
        .fontSize(36)
        .fontWeight(FontWeight.Medium)
        .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
        .backgroundColor(this.isRecording ? Constants.COLOR_DANGER : Constants.COLOR_PRIMARY)
        .shadow({
          radius: 12,
          color: this.isRecording ? 'rgba(230, 81, 0, 0.4)' : 'rgba(255, 107, 53, 0.4)',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          if (this.isRecording) {
            this.stopRecording();
          } else if (!this.isLongPressing) {
            this.onAddButtonClick();
          }
          this.isLongPressing = false;
        })
        .onTouch((event) => {
          if (event.type === 0 && !this.isRecording) {
            const timerId = setTimeout(() => {
              this.isLongPressing = true;
              this.onAddButtonLongPress();
            }, 500);
            this.longPressTimer = timerId as number;
          } else if (event.type === 1 || event.type === 3) {
            if (this.longPressTimer) {
              clearTimeout(this.longPressTimer);
              this.longPressTimer = 0;
            }
            this.isLongPressing = false;
          }
        })
    }
    .position({ x: '100%', y: '100%' })
    .translate({ x: -76, y: -140 })
    .zIndex(20)
  }

  /**
   * æ„å»ºè¾“å…¥æ 
   */
  @Builder
  buildInputBar() {
    Column() {
      // å½•éŸ³çŠ¶æ€æ˜¾ç¤º
      if (this.isRecording) {
        Row() {
          // å½•éŸ³åŠ¨ç”»æŒ‡ç¤ºå™¨
          Column() {
            Text('â—')
              .fontSize(20)
              .fontColor(Constants.COLOR_DANGER)
          }
          .width(24)
          .height(24)
          .justifyContent(FlexAlign.Center)
          .animation({
            iterations: -1,
            duration: 1000,
            curve: Curve.EaseInOut
          })

          // å½•éŸ³æ—¶é•¿
          Text(`å½•éŸ³ä¸­ ${this.formatDuration(this.recordingDuration)}`)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor(Constants.COLOR_DANGER)
            .margin({ left: 10 })

          Blank()

          // åœæ­¢å½•éŸ³æŒ‰é’®
          Button('åœæ­¢')
            .type(ButtonType.Normal)
            .height(36)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(Constants.COLOR_DANGER)
            .fontColor('#FFFFFF')
            .borderRadius(18)
            .padding({ left: 16, right: 16 })
            .margin({ left: 8 })
            .onClick(() => {
              this.stopRecording();
            })
        }
        .width('100%')
        .padding(14)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius(12)
        .margin({ bottom: 10 })
      }

      Row() {
        // è¾“å…¥æ¡†
        TextInput({ 
          placeholder: this.isRecording ? 'æ­£åœ¨å½•éŸ³...' : 'è¾“å…¥è´¦å•æè¿°ï¼Œå¦‚ï¼šåˆé¤15å…ƒ',
          text: this.inputText
        })
          .layoutWeight(1)
          .height(44)
          .fontSize(15)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .borderRadius(22)
          .padding({ left: 16, right: 16 })
          .enabled(!this.isRecording)
          .onChange((value: string) => {
            this.inputText = value;
          })

        // å‘é€æŒ‰é’®
        Button('å‘é€')
          .type(ButtonType.Normal)
          .height(44)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
          .borderRadius(22)
          .padding({ left: 20, right: 20 })
          .margin({ left: 10 })
          .shadow({
            radius: 6,
            color: 'rgba(255, 107, 53, 0.3)',
            offsetX: 0,
            offsetY: 2
          })
          .enabled(!this.isProcessing && !this.isRecording && this.inputText.trim().length > 0)
          .onClick(() => {
            this.onSendInput();
          })

        // å…³é—­æŒ‰é’®
        Button('Ã—')
          .type(ButtonType.Circle)
          .fontSize(20)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .width(36)
          .height(36)
          .margin({ left: 10 })
          .onClick(() => {
            this.onCloseInputBar();
          })
      }
      .width('100%')
      .padding(14)
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius(16)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor(Constants.COLOR_BACKGROUND_SECONDARY)
    .borderRadius({ topLeft: 20, topRight: 20 })
    .alignItems(HorizontalAlign.Start)
    .position({ x: 0, y: '100%' })
    .translate({ y: this.isRecording ? -200 : -140 })
    .zIndex(100)
    .shadow({
      radius: 16,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetX: 0,
      offsetY: -4
    })
  }

  /**
   * æ„å»ºè´¦å•è¯¦æƒ…
   */
  @Builder
  buildBillDetail() {
    if (this.selectedBill !== null) {
      Column() {
        // åŠé€æ˜èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#000000')
          .opacity(0.5)
          .onClick(() => {
            this.showBillDetail = false;
            this.selectedBill = null;
          })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(200)

      Column() {
        // è¯¦æƒ…å†…å®¹
        Column() {
          Text('è´¦å•è¯¦æƒ…')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Constants.COLOR_TEXT_PRIMARY)
            .margin({ bottom: 24 })

          // é‡‘é¢æ˜¾ç¤º
          Column() {
            Text(this.selectedBill.getDisplayAmount())
              .fontSize(36)
              .fontWeight(FontWeight.Bold)
              .fontColor(
                this.selectedBill.isIncome() ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER
              )
          }
          .width('100%')
          .padding(20)
          .backgroundColor(this.selectedBill.isIncome() ? 'rgba(255, 167, 38, 0.1)' : 'rgba(255, 107, 53, 0.08)')
          .borderRadius(12)
          .margin({ bottom: 20 })

          // åˆ†ç±»
          Row() {
            Text('åˆ†ç±»')
              .fontSize(15)
              .fontColor(Constants.COLOR_TEXT_SECONDARY)
            Blank()
            Row() {
              Text(this.getCategoryIcon(this.selectedBill.category))
                .fontSize(16)
              Text(this.getCategoryName(this.selectedBill.category))
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor(Constants.COLOR_TEXT_PRIMARY)
                .margin({ left: 6 })
            }
          }
          .width('100%')
          .padding({ top: 14, bottom: 14 })
          .borderWidth({ bottom: 1 })
          .borderColor(Constants.COLOR_DIVIDER)

          // æè¿°
          if (this.selectedBill.description) {
            Row() {
              Text('æè¿°')
                .fontSize(15)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
              Blank()
              Text(this.selectedBill.description)
                .fontSize(15)
                .fontColor(Constants.COLOR_TEXT_PRIMARY)
            }
            .width('100%')
            .padding({ top: 14, bottom: 14 })
            .borderWidth({ bottom: 1 })
            .borderColor(Constants.COLOR_DIVIDER)
          }

          // æ—¶é—´
          Row() {
            Text('æ—¶é—´')
              .fontSize(15)
              .fontColor(Constants.COLOR_TEXT_SECONDARY)
            Blank()
            Text(Utils.formatDate(this.selectedBill.date, Constants.DATETIME_FORMAT))
              .fontSize(15)
              .fontColor(Constants.COLOR_TEXT_PRIMARY)
          }
          .width('100%')
          .padding({ top: 14, bottom: 14 })
        }
        .width('100%')
        .padding(24)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius(20)

        // å…³é—­æŒ‰é’®
        Button('å…³é—­')
          .type(ButtonType.Normal)
          .width('100%')
          .height(50)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
          .borderRadius(25)
          .margin({ top: 16 })
          .shadow({
            radius: 8,
            color: 'rgba(255, 107, 53, 0.3)',
            offsetX: 0,
            offsetY: 2
          })
          .onClick(() => {
            this.showBillDetail = false;
            this.selectedBill = null;
          })
      }
      .width('90%')
      .padding(20)
      .position({ x: '5%', y: '20%' })
      .zIndex(201)
    }
  }

  /**
   * æ„å»ºé¢„ç®—è®¾ç½®å¼¹çª—
   */
  @Builder
  buildBudgetDialog() {
    // åŠé€æ˜èƒŒæ™¯
    Column()
      .width('100%')
      .height('100%')
      .backgroundColor('#000000')
      .opacity(0.5)
      .onClick(() => {
        this.showBudgetDialog = false;
      })
      .position({ x: 0, y: 0 })
      .zIndex(300)

    // å¼¹çª—å†…å®¹
    Column() {
      Text('è®¾ç½®æœˆé¢„ç®—')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .margin({ bottom: 20 })

      Text('è®¾ç½®æ¯æœˆé¢„ç®—é‡‘é¢ï¼Œå¸®åŠ©æ‚¨æ§åˆ¶æ”¯å‡º')
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .margin({ bottom: 24 })

      // é¢„ç®—è¾“å…¥æ¡†
      Row() {
        Text('Â¥')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .margin({ right: 8 })

        TextInput({ placeholder: 'è¯·è¾“å…¥é¢„ç®—é‡‘é¢', text: this.budgetInputText })
          .type(InputType.Number)
          .layoutWeight(1)
          .height(50)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .borderRadius(12)
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.budgetInputText = value;
          })
      }
      .width('100%')
      .margin({ bottom: 24 })

      // å¿«æ·é‡‘é¢é€‰æ‹©
      Row() {
        ForEach([1000, 2000, 3000, 5000], (amount: number) => {
          Button(`${amount}`)
            .type(ButtonType.Normal)
            .height(36)
            .fontSize(14)
            .backgroundColor(Constants.COLOR_BACKGROUND)
            .fontColor(Constants.COLOR_TEXT_PRIMARY)
            .borderRadius(18)
            .padding({ left: 16, right: 16 })
            .margin({ right: 8 })
            .onClick(() => {
              this.budgetInputText = amount.toString();
            })
        })
      }
      .width('100%')
      .margin({ bottom: 24 })

      // æŒ‰é’®ç»„
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .layoutWeight(1)
          .height(48)
          .fontSize(16)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .borderRadius(24)
          .margin({ right: 12 })
          .onClick(() => {
            this.showBudgetDialog = false;
          })

        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .layoutWeight(1)
          .height(48)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
          .borderRadius(24)
          .onClick(() => {
            const budget = parseFloat(this.budgetInputText);
            if (!isNaN(budget) && budget >= 0) {
              this.saveBudget(budget);
              this.showBudgetDialog = false;
            } else {
              promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é¢„ç®—é‡‘é¢' });
            }
          })
      }
      .width('100%')
    }
    .width('90%')
    .padding(24)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(20)
    .position({ x: '5%', y: '30%' })
    .zIndex(301)
  }

  /**
   * è·å–åˆ†ç±»å›¾æ ‡
   */
  private getCategoryIcon(category: BillCategory): string {
    if (category === BillCategory.FOOD) {
      return 'ğŸ”';
    } else if (category === BillCategory.TRANSPORT) {
      return 'ğŸš—';
    } else if (category === BillCategory.SHOPPING) {
      return 'ğŸ›ï¸';
    } else if (category === BillCategory.ENTERTAINMENT) {
      return 'ğŸ¬';
    } else if (category === BillCategory.MEDICAL) {
      return 'ğŸ¥';
    } else if (category === BillCategory.EDUCATION) {
      return 'ğŸ“š';
    } else if (category === BillCategory.HOUSING) {
      return 'ğŸ ';
    } else if (category === BillCategory.UTILITIES) {
      return 'ğŸ’¡';
    } else if (category === BillCategory.SALARY) {
      return 'ğŸ’°';
    } else if (category === BillCategory.BONUS) {
      return 'ğŸ';
    } else if (category === BillCategory.INVESTMENT) {
      return 'ğŸ“ˆ';
    } else if (category === BillCategory.GIFT) {
      return 'ğŸ';
    } else {
      return 'ğŸ“';
    }
  }

  /**
   * è·å–åˆ†ç±»åç§°
   */
  private getCategoryName(category: BillCategory): string {
    if (category === BillCategory.FOOD) {
      return 'é¤é¥®';
    } else if (category === BillCategory.TRANSPORT) {
      return 'äº¤é€š';
    } else if (category === BillCategory.SHOPPING) {
      return 'è´­ç‰©';
    } else if (category === BillCategory.ENTERTAINMENT) {
      return 'å¨±ä¹';
    } else if (category === BillCategory.MEDICAL) {
      return 'åŒ»ç–—';
    } else if (category === BillCategory.EDUCATION) {
      return 'æ•™è‚²';
    } else if (category === BillCategory.HOUSING) {
      return 'ä½æˆ¿';
    } else if (category === BillCategory.UTILITIES) {
      return 'æ°´ç”µ';
    } else if (category === BillCategory.SALARY) {
      return 'å·¥èµ„';
    } else if (category === BillCategory.BONUS) {
      return 'å¥–é‡‘';
    } else if (category === BillCategory.INVESTMENT) {
      return 'æŠ•èµ„';
    } else if (category === BillCategory.GIFT) {
      return 'ç¤¼é‡‘';
    } else if (category === BillCategory.OTHER_EXPENSE) {
      return 'å…¶ä»–æ”¯å‡º';
    } else if (category === BillCategory.OTHER_INCOME) {
      return 'å…¶ä»–æ”¶å…¥';
    } else {
      return 'å…¶ä»–';
    }
  }

  /**
   * è·å–æ˜ŸæœŸå‡ 
   */
  private getWeekDay(): string {
    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    return days[new Date().getDay()];
  }

  /**
   * æŒ‰æ—¥æœŸåˆ†ç»„è´¦å•
   */
  private groupBillsByDate(bills: Bill[]): BillGroup[] {
    const groups: Map<string, Bill[]> = new Map();
    
    bills.forEach(bill => {
      const dateStr = Utils.formatDate(bill.date, 'MMæœˆDDæ—¥');
      if (!groups.has(dateStr)) {
        groups.set(dateStr, []);
      }
      groups.get(dateStr)?.push(bill);
    });

    const result: BillGroup[] = [];
    groups.forEach((groupBills, date) => {
      // æ¯ç»„å†…æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      groupBills.sort((a: Bill, b: Bill): number => {
        return b.createTime.getTime() - a.createTime.getTime();
      });
      const group: BillGroup = {
        date: date,
        bills: groupBills
      };
      result.push(group);
    });

    // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
    result.sort((a: BillGroup, b: BillGroup): number => {
      return b.date.localeCompare(a.date);
    });

    return result;
  }
}