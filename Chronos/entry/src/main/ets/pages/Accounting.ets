import { BillItem } from '../components/BillItem';
import { BillService } from '../service/BillService';
import { Bill, BillType, BillCategory } from '../model/Bill';
import { Constants } from '../common/Constants';
import { Utils } from '../common/Utils';
import { MimoAIService, BillRecognitionResult } from '../service/MimoAIService';

/**
 * è´¦å•åˆ†ç»„æ¥å£
 */
interface BillGroup {
  date: string;
  bills: Bill[];
}

/**
 * AIè®°è´¦é¡µé¢ - å‚è€ƒæˆªå›¾è®¾è®¡
 */
@Component
export struct Accounting {
  @State bills: Bill[] = [];
  @State todayBills: Bill[] = [];
  @State todayIncome: number = 0;
  @State todayExpense: number = 0;
  @State monthExpense: number = 0;
  @State monthIncome: number = 0;
  @State monthBalance: number = 0;
  
  // è¾“å…¥æ ç›¸å…³çŠ¶æ€
  @State showInputBar: boolean = false;
  @State inputText: string = '';
  @State isRecording: boolean = false;
  @State isProcessing: boolean = false;
  
  // è´¦å•è¯¦æƒ…
  @State selectedBill: Bill | null = null;
  @State showBillDetail: boolean = false;
  
  // å†å²è´¦å•åˆ†ç»„æ•°æ®
  @State historyBillGroups: BillGroup[] = [];

  private billService: BillService = BillService.getInstance();
  private aiService: MimoAIService = MimoAIService.getInstance();

  aboutToAppear() {
    this.loadBills();
    this.loadStatistics();
    // è®¾ç½®MIMO API Keyï¼ˆä»é…ç½®ä¸­è¯»å–ï¼‰
    // TODO: ä»é…ç½®æ–‡ä»¶æˆ–ç”¨æˆ·è®¾ç½®ä¸­è¯»å–API Key
    const apiKey = Constants.MIMO_API_KEY;
    if (apiKey && apiKey.length > 0) {
      this.aiService.setApiKey(apiKey);
    }
  }

  /**
   * åŠ è½½è´¦å•
   */
  async loadBills(): Promise<void> {
    const allBills = await this.billService.getAllBills();
    this.bills = [...allBills];
    
    // ç­›é€‰ä»Šå¤©çš„è´¦å•
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    this.todayBills = allBills.filter(bill => {
      const billDate = new Date(bill.date);
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() === today.getTime();
    });
    
    // åŠ è½½å†å²è´¦å•åˆ†ç»„
    const historyBills = allBills.filter(bill => {
      const billDate = new Date(bill.date);
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() < today.getTime();
    });
    this.historyBillGroups = this.groupBillsByDate(historyBills);
  }

  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  async loadStatistics(): Promise<void> {
    const todayBills = await this.billService.getTodayBills();
    const monthBills = await this.billService.getMonthBills();
    
    this.todayIncome = this.billService.calculateIncome(todayBills);
    this.todayExpense = this.billService.calculateExpense(todayBills);
    this.monthIncome = this.billService.calculateIncome(monthBills);
    this.monthExpense = this.billService.calculateExpense(monthBills);
    this.monthBalance = this.monthIncome - this.monthExpense;
  }

  /**
   * ç‚¹å‡»åŠ å· - å±•å¼€è¾“å…¥æ 
   */
  onAddButtonClick(): void {
    this.showInputBar = true;
    this.inputText = '';
  }

  /**
   * é•¿æŒ‰åŠ å· - å¼€å§‹å½•éŸ³æ¨¡å¼
   */
  onAddButtonLongPress(): void {
    this.isRecording = true;
    this.showInputBar = true;
    // TODO: å®ç°å½•éŸ³åŠŸèƒ½
    console.info('å¼€å§‹å½•éŸ³...');
  }

  /**
   * å‘é€è¾“å…¥æ–‡æœ¬åˆ°AIè¯†åˆ«
   */
  async onSendInput(): Promise<void> {
    if (!this.inputText.trim()) {
      return;
    }

    this.isProcessing = true;
    
    try {
      // è°ƒç”¨MIMO AIè¯†åˆ«è´¦å•
      const result: BillRecognitionResult = await this.aiService.recognizeBill(this.inputText);
      
      // åˆ›å»ºè´¦å•
      const bill = new Bill();
      bill.type = result.type;
      bill.category = result.category;
      bill.amount = result.amount || 0;
      bill.description = result.description || this.inputText;
      bill.date = new Date();
      
      // ä¿å­˜è´¦å•
      await this.billService.createBill(bill);
      
      // åˆ·æ–°æ•°æ®
      await this.loadBills();
      await this.loadStatistics();
      
      // æ¸…ç©ºè¾“å…¥
      this.inputText = '';
      this.showInputBar = false;
    } catch (error) {
      console.error('AIè¯†åˆ«å¤±è´¥:', error);
      // TODO: æ˜¾ç¤ºé”™è¯¯æç¤º
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å…³é—­è¾“å…¥æ 
   */
  onCloseInputBar(): void {
    this.showInputBar = false;
    this.inputText = '';
    this.isRecording = false;
  }

  /**
   * ç‚¹å‡»è´¦å•æŸ¥çœ‹è¯¦æƒ…
   */
  onBillTap(bill: Bill): void {
    this.selectedBill = bill;
    this.showBillDetail = true;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
        this.buildSummaryCard()
        
        // ä»Šå¤©çš„è´¦å•åˆ—è¡¨
        this.buildTodayBillsList()
        
        // å†å²è´¦å•åˆ—è¡¨
        this.buildHistoryBillsList()
      }
      .width('100%')
      .flexGrow(1)
      .backgroundColor(Constants.COLOR_BACKGROUND)

      // å³ä¸‹è§’åŠ å·æŒ‰é’®
      this.buildAddButton()

      // è¾“å…¥æ ï¼ˆç‚¹å‡»åŠ å·æ—¶æ˜¾ç¤ºï¼‰
      if (this.showInputBar) {
        this.buildInputBar()
      }

      // è´¦å•è¯¦æƒ…å¼¹çª—
      if (this.showBillDetail && this.selectedBill) {
        this.buildBillDetail()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºé¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  buildSummaryCard() {
    Column() {
      // 12æœˆæ”¯å‡ºæ ‡é¢˜
      Row() {
        Text('12æœˆæ”¯å‡º')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Text('ğŸ‘')
          .fontSize(20)
      }
      .width('100%')
      .margin({ bottom: 16 })

      // æ”¯å‡ºé‡‘é¢
      Text(`Â¥${this.monthExpense.toFixed(2)}`)
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .margin({ bottom: 12 })

      // æ”¶å…¥å’Œç»“ä½™
      Row() {
        Column() {
          Text('æ”¶å…¥')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
          Text(`Â¥${this.monthIncome.toFixed(2)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(Constants.COLOR_SUCCESS)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Column() {
          Text('ç»“ä½™')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
          Text(`Â¥${this.monthBalance.toFixed(2)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(Constants.COLOR_PRIMARY)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .margin({ bottom: 16 })

      // æœˆé¢„ç®—è¿›åº¦æ¡
      Row() {
        Text('æœˆé¢„ç®—66%')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
        
        Blank()
        
        Text('å‰©ä½™ Â¥407.25')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
      }
      .width('100%')
      .margin({ bottom: 8 })

      // è¿›åº¦æ¡ï¼ˆä½¿ç”¨Rowæ¨¡æ‹Ÿï¼‰
      Row() {
        Row()
          .width('66%')
          .height(6)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .borderRadius(3)
      }
      .width('100%')
      .height(6)
      .backgroundColor(Constants.COLOR_BORDER)
      .borderRadius(3)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ top: 16, left: 16, right: 16, bottom: 12 })
  }

  /**
   * æ„å»ºä»Šå¤©çš„è´¦å•åˆ—è¡¨
   */
  @Builder
  buildTodayBillsList() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text(`ä»Šå¤© ${Utils.formatDate(new Date(), 'MMæœˆDDæ—¥')} (${this.getWeekDay()})`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Text('>')
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // ä»Šæ—¥ç»Ÿè®¡
      Text(`æ”¯å‡ºÂ¥${this.todayExpense.toFixed(2)} | æ”¶å…¥Â¥${this.todayIncome.toFixed(2)}`)
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .padding({ left: 16, right: 16, bottom: 12 })

      // è´¦å•åˆ—è¡¨
      if (this.todayBills.length === 0) {
        Column() {
          Text('ä»Šå¤©è¿˜æ²¡æœ‰è´¦å•')
            .fontSize(14)
            .fontColor(Constants.COLOR_TEXT_SECONDARY)
        }
        .width('100%')
        .padding(20)
      } else {
        Column() {
          ForEach(this.todayBills, (bill: Bill) => {
            this.buildBillItem(bill)
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 12 })
  }

  /**
   * æ„å»ºå†å²è´¦å•åˆ—è¡¨
   */
  @Builder
  buildHistoryBillsList() {
    if (this.historyBillGroups.length > 0) {
      Column() {
        ForEach(this.historyBillGroups, (group: BillGroup) => {
          Column() {
            // æ—¥æœŸæ ‡é¢˜
            Row() {
              Text(group.date)
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
              
              Blank()
              
              Text('>')
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 8 })

            // è¯¥æ—¥æœŸçš„è´¦å•
            Column() {
              ForEach(group.bills, (bill: Bill) => {
                this.buildBillItem(bill)
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 8 })
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 12 })
        })
      }
      .width('100%')
    }
  }

  /**
   * æ„å»ºå•ä¸ªè´¦å•é¡¹
   */
  @Builder
  buildBillItem(bill: Bill) {
    Row() {
      // æ—¶é—´
      Text(Utils.formatDate(bill.date, 'HH:mm'))
        .fontSize(14)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .width(50)

      // åˆ†ç±»å›¾æ ‡å’Œåç§°
      Row() {
        Text(this.getCategoryIcon(bill.category))
          .fontSize(20)
        Text(this.getCategoryName(bill.category))
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .margin({ left: 8 })
      }
      .layoutWeight(1)
      .margin({ left: 12 })

      // é‡‘é¢
      Text(bill.getDisplayAmount())
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(
          bill.isIncome() ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER
        )
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Constants.COLOR_BACKGROUND_SECONDARY)
    .borderRadius(8)
    .margin({ bottom: 8 })
    .onClick(() => {
      this.onBillTap(bill);
    })
  }

  /**
   * æ„å»ºåŠ å·æŒ‰é’®
   */
  @Builder
  buildAddButton() {
    Button('+')
      .type(ButtonType.Circle)
      .width(56)
      .height(56)
      .fontSize(32)
      .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
      .backgroundColor(Constants.COLOR_PRIMARY)
      .position({ x: '100%', y: '100%' })
      .margin({ right: 16, bottom: 16 })
      .onClick(() => {
        this.onAddButtonClick();
      })
  }

  /**
   * æ„å»ºè¾“å…¥æ 
   */
  @Builder
  buildInputBar() {
    Column() {
      Row() {
        // è¾“å…¥æ¡†
        TextInput({ placeholder: this.isRecording ? 'æ­£åœ¨å½•éŸ³...' : 'è¾“å…¥è´¦å•æè¿°ï¼Œå¦‚ï¼šåˆé¤15å…ƒ' })
          .layoutWeight(1)
          .fontSize(16)
          .onChange((value: string) => {
            this.inputText = value;
          })

        // å‘é€æŒ‰é’®
        Button('å‘é€')
          .type(ButtonType.Normal)
          .fontSize(14)
          .backgroundColor(Constants.COLOR_PRIMARY)
          .fontColor(Constants.COLOR_TEXT_ON_PRIMARY)
          .margin({ left: 8 })
          .enabled(!this.isProcessing && this.inputText.trim().length > 0)
          .onClick(() => {
            this.onSendInput();
          })

        // å…³é—­æŒ‰é’®
        Button('Ã—')
          .type(ButtonType.Normal)
          .fontSize(20)
          .backgroundColor(Constants.COLOR_BORDER)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .width(32)
          .height(32)
          .margin({ left: 8 })
          .onClick(() => {
            this.onCloseInputBar();
          })
      }
      .width('100%')
      .padding(12)
      .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
      .borderRadius(8)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_BACKGROUND_SECONDARY)
    .position({ x: 0, y: '100%' })
    .translate({ y: -80 })
  }

  /**
   * æ„å»ºè´¦å•è¯¦æƒ…
   */
  @Builder
  buildBillDetail() {
    if (this.selectedBill !== null) {
      Column() {
        // è¯¦æƒ…å†…å®¹
        Column() {
          Text('è´¦å•è¯¦æƒ…')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 20 })

          Row() {
            Text('é‡‘é¢ï¼š')
            Text(this.selectedBill.getDisplayAmount())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(
                this.selectedBill.isIncome() ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER
              )
          }
          .width('100%')
          .margin({ bottom: 12 })

          Row() {
            Text('åˆ†ç±»ï¼š')
            Text(this.getCategoryName(this.selectedBill.category))
          }
          .width('100%')
          .margin({ bottom: 12 })

          if (this.selectedBill.description) {
            Row() {
              Text('æè¿°ï¼š')
              Text(this.selectedBill.description)
            }
            .width('100%')
            .margin({ bottom: 12 })
          }

          Row() {
            Text('æ—¶é—´ï¼š')
            Text(Utils.formatDate(this.selectedBill.date, Constants.DATETIME_FORMAT))
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius(12)

        // å…³é—­æŒ‰é’®
        Button('å…³é—­')
          .type(ButtonType.Normal)
          .width('100%')
          .margin({ top: 12 })
          .onClick(() => {
            this.showBillDetail = false;
            this.selectedBill = null;
          })
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Constants.COLOR_BACKGROUND)
      .borderRadius(16)
      .position({ x: '5%', y: '20%' })
    }
  }

  /**
   * è·å–åˆ†ç±»å›¾æ ‡
   */
  private getCategoryIcon(category: BillCategory): string {
    if (category === BillCategory.FOOD) {
      return 'ğŸ”';
    } else if (category === BillCategory.TRANSPORT) {
      return 'ğŸš—';
    } else if (category === BillCategory.SHOPPING) {
      return 'ğŸ›ï¸';
    } else if (category === BillCategory.ENTERTAINMENT) {
      return 'ğŸ¬';
    } else if (category === BillCategory.MEDICAL) {
      return 'ğŸ¥';
    } else if (category === BillCategory.EDUCATION) {
      return 'ğŸ“š';
    } else if (category === BillCategory.HOUSING) {
      return 'ğŸ ';
    } else if (category === BillCategory.UTILITIES) {
      return 'ğŸ’¡';
    } else if (category === BillCategory.SALARY) {
      return 'ğŸ’°';
    } else if (category === BillCategory.BONUS) {
      return 'ğŸ';
    } else if (category === BillCategory.INVESTMENT) {
      return 'ğŸ“ˆ';
    } else if (category === BillCategory.GIFT) {
      return 'ğŸ';
    } else {
      return 'ğŸ“';
    }
  }

  /**
   * è·å–åˆ†ç±»åç§°
   */
  private getCategoryName(category: BillCategory): string {
    if (category === BillCategory.FOOD) {
      return 'é¤é¥®';
    } else if (category === BillCategory.TRANSPORT) {
      return 'äº¤é€š';
    } else if (category === BillCategory.SHOPPING) {
      return 'è´­ç‰©';
    } else if (category === BillCategory.ENTERTAINMENT) {
      return 'å¨±ä¹';
    } else if (category === BillCategory.MEDICAL) {
      return 'åŒ»ç–—';
    } else if (category === BillCategory.EDUCATION) {
      return 'æ•™è‚²';
    } else if (category === BillCategory.HOUSING) {
      return 'ä½æˆ¿';
    } else if (category === BillCategory.UTILITIES) {
      return 'æ°´ç”µ';
    } else if (category === BillCategory.SALARY) {
      return 'å·¥èµ„';
    } else if (category === BillCategory.BONUS) {
      return 'å¥–é‡‘';
    } else if (category === BillCategory.INVESTMENT) {
      return 'æŠ•èµ„';
    } else if (category === BillCategory.GIFT) {
      return 'ç¤¼é‡‘';
    } else if (category === BillCategory.OTHER_EXPENSE) {
      return 'å…¶ä»–æ”¯å‡º';
    } else if (category === BillCategory.OTHER_INCOME) {
      return 'å…¶ä»–æ”¶å…¥';
    } else {
      return 'å…¶ä»–';
    }
  }

  /**
   * è·å–æ˜ŸæœŸå‡ 
   */
  private getWeekDay(): string {
    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    return days[new Date().getDay()];
  }

  /**
   * æŒ‰æ—¥æœŸåˆ†ç»„è´¦å•
   */
  private groupBillsByDate(bills: Bill[]): BillGroup[] {
    const groups: Map<string, Bill[]> = new Map();
    
    bills.forEach(bill => {
      const dateStr = Utils.formatDate(bill.date, 'MMæœˆDDæ—¥');
      if (!groups.has(dateStr)) {
        groups.set(dateStr, []);
      }
      groups.get(dateStr)?.push(bill);
    });

    const result: BillGroup[] = [];
    groups.forEach((bills, date) => {
      const group: BillGroup = {
        date: date,
        bills: bills
      };
      result.push(group);
    });

    // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
    result.sort((a: BillGroup, b: BillGroup): number => {
      return b.date.localeCompare(a.date);
    });

    return result;
  }
}