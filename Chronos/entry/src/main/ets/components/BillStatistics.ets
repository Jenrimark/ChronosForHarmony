import { Bill, BillType, BillCategory } from '../model/Bill';
import { BillService } from '../service/BillService';
import { Constants } from '../common/Constants';
import { Utils } from '../common/Utils';

/**
 * ç»Ÿè®¡æ—¶é—´èŒƒå›´ç±»å‹
 */
type StatsPeriod = 'day' | 'week' | 'month' | 'year' | 'custom';

/**
 * åˆ†ç±»ç»Ÿè®¡æ•°æ®
 */
interface CategoryStats {
  category: BillCategory;
  icon: string;
  name: string;
  amount: number;
  percentage: number;
  count: number;
}

/**
 * æ—¥ç»Ÿè®¡æ•°æ®
 */
interface DailyStats {
  date: string;
  dateLabel: string;
  expense: number;
  income: number;
}

/**
 * å‘¨æ—¥æœŸèŒƒå›´
 */
interface WeekDateRange {
  start: Date;
  end: Date;
}

/**
 * è´¦å•ç»Ÿè®¡ç»„ä»¶
 */
@Component
export struct BillStatistics {
  @Link isShow: boolean;
  
  // ç»Ÿè®¡æ•°æ®
  @State period: StatsPeriod = 'week';
  @State startDate: Date = new Date();
  @State endDate: Date = new Date();
  @State totalExpense: number = 0;
  @State totalIncome: number = 0;
  @State totalBalance: number = 0;
  @State categoryStats: CategoryStats[] = [];
  @State dailyStats: DailyStats[] = [];
  @State topExpenses: Bill[] = [];
  @State topIncomes: Bill[] = [];
  @State allBillsInRange: Bill[] = [];
  @State showCategoryExpenseTab: boolean = true; // åˆ†ç±»ç»Ÿè®¡çš„æ”¯å‡º/æ”¶å…¥åˆ‡æ¢
  @State showTopBillsExpenseTab: boolean = true; // å•ç¬”æ’è¡Œçš„æ”¯å‡º/æ”¶å…¥åˆ‡æ¢
  @State categoryStatsForIncome: CategoryStats[] = []; // æ”¶å…¥åˆ†ç±»ç»Ÿè®¡
  @State selectedDate: Date = new Date(); // ç”¨äºæ—¥æœŸé€‰æ‹©
  @State showYearPicker: boolean = false; // å¹´ä»½é€‰æ‹©å™¨
  @State showMonthPicker: boolean = false; // æœˆä»½é€‰æ‹©å™¨
  @State showWeekPicker: boolean = false; // å‘¨é€‰æ‹©å™¨
  @State showCustomRangePicker: boolean = false; // è‡ªå®šä¹‰èŒƒå›´é€‰æ‹©å™¨
  @State tempSelectedYear: number = new Date().getFullYear();
  @State tempSelectedMonth: number = new Date().getMonth();
  @State tempSelectedWeek: number = 1;
  
  private billService: BillService = BillService.getInstance();

  aboutToAppear() {
    this.initDateRange();
    this.loadStatistics();
  }


  /**
   * åˆå§‹åŒ–æ—¥æœŸèŒƒå›´
   */
  initDateRange(): void {
    const today = new Date();
    this.endDate = new Date(today);
    
    if (this.period === 'week') {
      // æœ¬å‘¨
      const dayOfWeek = today.getDay();
      const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨ä¸€ä¸ºèµ·å§‹
      this.startDate = new Date(today);
      this.startDate.setDate(today.getDate() - diff);
    } else if (this.period === 'month') {
      // æœ¬æœˆ
      this.startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    } else if (this.period === 'year') {
      // æœ¬å¹´
      this.startDate = new Date(today.getFullYear(), 0, 1);
    }
    // custom ç±»å‹ä¸åœ¨è¿™é‡Œåˆå§‹åŒ–ï¼Œç”±ç”¨æˆ·é€‰æ‹©
    
    this.startDate.setHours(0, 0, 0, 0);
    this.endDate.setHours(23, 59, 59, 999);
  }

  /**
   * åˆ‡æ¢ç»Ÿè®¡å‘¨æœŸ
   */
  switchPeriod(newPeriod: StatsPeriod): void {
    this.period = newPeriod;
    this.initDateRange();
    this.loadStatistics();
  }

  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  async loadStatistics(): Promise<void> {
    try {
      const bills = await this.billService.getBillsByDateRange(this.startDate, this.endDate);
      this.allBillsInRange = bills;
      
      // è®¡ç®—æ€»æ”¶æ”¯
      this.totalExpense = this.billService.calculateExpense(bills);
      this.totalIncome = this.billService.calculateIncome(bills);
      this.totalBalance = this.totalIncome - this.totalExpense;
      
      // è®¡ç®—åˆ†ç±»ç»Ÿè®¡ï¼ˆæ”¯å‡ºå’Œæ”¶å…¥ï¼‰
      this.calculateCategoryStats(bills);
      this.calculateIncomeCategoryStats(bills);
      
      // è®¡ç®—æ¯æ—¥ç»Ÿè®¡
      this.calculateDailyStats(bills);
      
      // è·å–æ’è¡Œæ¦œ
      this.calculateTopBills(bills);
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
  }

  /**
   * è®¡ç®—æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡
   */
  calculateCategoryStats(bills: Bill[]): void {
    const expenseBills = bills.filter(b => b.isExpense());
    const categoryMap: Map<BillCategory, number> = new Map();
    const countMap: Map<BillCategory, number> = new Map();
    
    expenseBills.forEach(bill => {
      const current = categoryMap.get(bill.category) || 0;
      categoryMap.set(bill.category, current + bill.amount);
      const count = countMap.get(bill.category) || 0;
      countMap.set(bill.category, count + 1);
    });
    
    const stats: CategoryStats[] = [];
    categoryMap.forEach((amount, category) => {
      const percentage = this.totalExpense > 0 ? (amount / this.totalExpense) * 100 : 0;
      stats.push({
        category: category,
        icon: this.getCategoryIcon(category),
        name: this.getCategoryName(category),
        amount: amount,
        percentage: percentage,
        count: countMap.get(category) || 0
      });
    });
    
    // æŒ‰é‡‘é¢é™åºæ’åˆ—
    stats.sort((a, b) => b.amount - a.amount);
    this.categoryStats = stats;
  }

  /**
   * è®¡ç®—æ”¶å…¥åˆ†ç±»ç»Ÿè®¡
   */
  calculateIncomeCategoryStats(bills: Bill[]): void {
    const incomeBills = bills.filter(b => b.isIncome());
    const categoryMap: Map<BillCategory, number> = new Map();
    const countMap: Map<BillCategory, number> = new Map();
    
    incomeBills.forEach(bill => {
      const current = categoryMap.get(bill.category) || 0;
      categoryMap.set(bill.category, current + bill.amount);
      const count = countMap.get(bill.category) || 0;
      countMap.set(bill.category, count + 1);
    });
    
    const stats: CategoryStats[] = [];
    categoryMap.forEach((amount, category) => {
      const percentage = this.totalIncome > 0 ? (amount / this.totalIncome) * 100 : 0;
      stats.push({
        category: category,
        icon: this.getCategoryIcon(category),
        name: this.getCategoryName(category),
        amount: amount,
        percentage: percentage,
        count: countMap.get(category) || 0
      });
    });
    
    // æŒ‰é‡‘é¢é™åºæ’åˆ—
    stats.sort((a, b) => b.amount - a.amount);
    this.categoryStatsForIncome = stats;
  }


  /**
   * è®¡ç®—æ¯æ—¥ç»Ÿè®¡
   */
  calculateDailyStats(bills: Bill[]): void {
    const dailyMap: Map<string, DailyStats> = new Map();
    
    // åˆå§‹åŒ–æ—¥æœŸèŒƒå›´å†…çš„æ¯ä¸€å¤©
    const current = new Date(this.startDate);
    while (current <= this.endDate) {
      const dateStr = Utils.formatDate(current, 'YYYY-MM-DD');
      const dateLabel = Utils.formatDate(current, 'MM.DD');
      dailyMap.set(dateStr, {
        date: dateStr,
        dateLabel: dateLabel,
        expense: 0,
        income: 0
      });
      current.setDate(current.getDate() + 1);
    }
    
    // ç»Ÿè®¡æ¯æ—¥æ•°æ®
    bills.forEach(bill => {
      const dateStr = Utils.formatDate(bill.date, 'YYYY-MM-DD');
      const stats = dailyMap.get(dateStr);
      if (stats) {
        if (bill.isExpense()) {
          stats.expense += bill.amount;
        } else {
          stats.income += bill.amount;
        }
      }
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„
    this.dailyStats = Array.from(dailyMap.values());
  }

  /**
   * è®¡ç®—æ’è¡Œæ¦œ
   */
  calculateTopBills(bills: Bill[]): void {
    const expenses = bills.filter(b => b.isExpense()).sort((a, b) => b.amount - a.amount);
    const incomes = bills.filter(b => b.isIncome()).sort((a, b) => b.amount - a.amount);
    
    this.topExpenses = expenses.slice(0, 5);
    this.topIncomes = incomes.slice(0, 5);
  }

  /**
   * è·å–æ—¥æœŸèŒƒå›´æ˜¾ç¤ºæ–‡æœ¬
   */
  getDateRangeText(): string {
    const startStr = Utils.formatDate(this.startDate, 'YYYY.MM.DD');
    const endStr = Utils.formatDate(this.endDate, 'YYYY.MM.DD');
    return `${startStr} ~ ${endStr}`;
  }

  /**
   * è·å–æœ€å¤§æ—¥æ”¯å‡ºï¼ˆç”¨äºå›¾è¡¨ç¼©æ”¾ï¼‰
   */
  getMaxDailyExpense(): number {
    let max = 0;
    this.dailyStats.forEach(stats => {
      if (stats.expense > max) max = stats.expense;
    });
    return max > 0 ? max : 100;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.buildHeader()
        
        // å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // æ€»ç»Ÿè®¡å¡ç‰‡
            this.buildSummaryCard()
            
            // AIåˆ†æå»ºè®®
            this.buildAIAnalysis()
            
            // æ¶ˆè´¹è¶‹åŠ¿
            this.buildDailyTrend()
            
            // åˆ†ç±»æ„æˆ
            this.buildCategoryChart()
            
            // å•ç¬”æ”¶æ”¯æ’è¡Œ
            this.buildTopBillsList()
            
            // è´¦å•æ±‡æ€»
            this.buildBillSummary()
          }
          .width('100%')
          .padding({ bottom: 20 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(Constants.COLOR_BACKGROUND)
      
      // å¹´ä»½é€‰æ‹©å™¨
      if (this.showYearPicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .justifyContent(FlexAlign.End)
          .onClick(() => {
            this.showYearPicker = false;
          })
        
        Column() {
          this.buildYearPicker()
        }
        .width('100%')
        .height(300)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius({ topLeft: 20, topRight: 20 })
      }
      
      // æœˆä»½é€‰æ‹©å™¨
      if (this.showMonthPicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .justifyContent(FlexAlign.End)
          .onClick(() => {
            this.showMonthPicker = false;
          })
        
        Column() {
          this.buildMonthPicker()
        }
        .width('100%')
        .height(300)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius({ topLeft: 20, topRight: 20 })
      }
      
      // å‘¨é€‰æ‹©å™¨
      if (this.showWeekPicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .justifyContent(FlexAlign.End)
          .onClick(() => {
            this.showWeekPicker = false;
          })
        
        Column() {
          this.buildWeekPicker()
        }
        .width('100%')
        .height(300)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius({ topLeft: 20, topRight: 20 })
      }
      
      // è‡ªå®šä¹‰èŒƒå›´é€‰æ‹©å™¨
      if (this.showCustomRangePicker) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .justifyContent(FlexAlign.End)
          .onClick(() => {
            this.showCustomRangePicker = false;
          })
        
        Column() {
          this.buildCustomRangePicker()
        }
        .width('100%')
        .height(400)
        .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
        .borderRadius({ topLeft: 20, topRight: 20 })
      }
    }
    .width('100%')
    .height('100%')
  }


  /**
   * æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
   */
  @Builder
  buildHeader() {
    Column() {
      // è¿”å›æŒ‰é’®å’Œæ ‡é¢˜
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .onClick(() => {
            this.isShow = false;
          })
        
        Text('è´¦å•ç»Ÿè®¡')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .margin({ left: 16 })
        
        Blank()
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      
      // å‘¨æœŸåˆ‡æ¢
      Row() {
        ForEach(['week', 'month', 'year', 'custom'] as StatsPeriod[], (p: StatsPeriod) => {
          Text(this.getPeriodLabel(p))
            .fontSize(14)
            .fontWeight(this.period === p ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.period === p ? Constants.COLOR_PRIMARY : Constants.COLOR_TEXT_SECONDARY)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.period === p ? 'rgba(255, 107, 53, 0.1)' : 'transparent')
            .borderRadius(16)
            .onClick(() => {
              this.switchPeriod(p);
            })
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
      .padding({ left: 16, right: 16, bottom: 12 })
      
      // æ—¥æœŸèŒƒå›´æ˜¾ç¤ºï¼ˆå¯ç‚¹å‡»é€‰æ‹©ï¼‰
      Text(this.getDateRangeText())
        .fontSize(14)
        .fontColor(Constants.COLOR_PRIMARY)
        .padding({ bottom: 12 })
        .onClick(() => {
          this.showDatePicker();
        })
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
  }

  /**
   * è·å–å‘¨æœŸæ ‡ç­¾
   */
  getPeriodLabel(period: StatsPeriod): string {
    if (period === 'week') return 'å‘¨';
    if (period === 'month') return 'æœˆ';
    if (period === 'year') return 'å¹´';
    return 'è‡ªå®šä¹‰';
  }

  /**
   * æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
   */
  showDatePicker(): void {
    if (this.period === 'custom') {
      // è‡ªå®šä¹‰ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰èŒƒå›´é€‰æ‹©å™¨
      this.showCustomRangePicker = true;
    } else if (this.period === 'week') {
      // å‘¨ï¼šæ˜¾ç¤ºå‘¨é€‰æ‹©å™¨
      this.tempSelectedYear = this.startDate.getFullYear();
      // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ å‘¨
      this.tempSelectedWeek = this.getWeekNumber(this.startDate);
      // ç¡®ä¿å‘¨æ•°åœ¨æœ‰æ•ˆèŒƒå›´å†…
      const maxWeek = this.getWeeks().length;
      if (this.tempSelectedWeek > maxWeek) {
        this.tempSelectedWeek = maxWeek;
      }
      if (this.tempSelectedWeek < 1) {
        this.tempSelectedWeek = 1;
      }
      this.showWeekPicker = true;
    } else if (this.period === 'month') {
      // æœˆï¼šæ˜¾ç¤ºæœˆä»½é€‰æ‹©å™¨
      this.tempSelectedYear = this.startDate.getFullYear();
      this.tempSelectedMonth = this.startDate.getMonth();
      this.showMonthPicker = true;
    } else if (this.period === 'year') {
      // å¹´ï¼šæ˜¾ç¤ºå¹´ä»½é€‰æ‹©å™¨
      this.tempSelectedYear = this.startDate.getFullYear();
      this.showYearPicker = true;
    }
  }

  /**
   * è·å–å¹´ä»½åˆ—è¡¨
   */
  getYears(): number[] {
    const years: number[] = [];
    const currentYear = new Date().getFullYear();
    for (let y = currentYear - 50; y <= currentYear + 50; y++) {
      years.push(y);
    }
    return years;
  }

  /**
   * è·å–æœˆä»½åˆ—è¡¨
   */
  getMonths(): number[] {
    const months: number[] = [];
    for (let m = 0; m < 12; m++) {
      months.push(m);
    }
    return months;
  }

  /**
   * è·å–å‘¨æ•°åˆ—è¡¨ï¼ˆä¸€å¹´æœ€å¤š53å‘¨ï¼‰
   */
  getWeeks(): number[] {
    const weeks: number[] = [];
    // è®¡ç®—è¯¥å¹´æœ‰å¤šå°‘å‘¨
    const firstDay = new Date(this.tempSelectedYear, 0, 1);
    const lastDay = new Date(this.tempSelectedYear, 11, 31);
    const firstWeekDay = firstDay.getDay() === 0 ? 7 : firstDay.getDay(); // è½¬æ¢ä¸ºå‘¨ä¸€åˆ°å‘¨æ—¥ä¸º1-7
    const daysInYear = Math.floor((lastDay.getTime() - firstDay.getTime()) / (1000 * 60 * 60 * 24)) + 1;
    const totalWeeks = Math.ceil((daysInYear + firstWeekDay - 1) / 7);
    for (let w = 1; w <= totalWeeks; w++) {
      weeks.push(w);
    }
    return weeks;
  }

  /**
   * è·å–æ—¥æœŸæ˜¯ç¬¬å‡ å‘¨
   */
  getWeekNumber(date: Date): number {
    const year = date.getFullYear();
    const firstDay = new Date(year, 0, 1);
    const firstWeekDay = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
    const days = Math.floor((date.getTime() - firstDay.getTime()) / (1000 * 60 * 60 * 24));
    return Math.ceil((days + firstWeekDay) / 7);
  }

  /**
   * æ ¹æ®å¹´ä»½å’Œå‘¨æ•°è®¡ç®—è¯¥å‘¨çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
   */
  getWeekDateRange(year: number, week: number): WeekDateRange {
    const firstDay = new Date(year, 0, 1);
    const firstWeekDay = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
    // è®¡ç®—è¯¥å‘¨ç¬¬ä¸€å¤©çš„æ—¥æœŸ
    const daysToAdd = (week - 1) * 7 - (firstWeekDay - 1);
    const weekStart = new Date(year, 0, 1 + daysToAdd);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);
    const range: WeekDateRange = { start: weekStart, end: weekEnd };
    return range;
  }

  /**
   * ç¡®è®¤å¹´ä»½é€‰æ‹©
   */
  confirmYearSelection(): void {
    this.startDate = new Date(this.tempSelectedYear, 0, 1);
    this.startDate.setHours(0, 0, 0, 0);
    this.endDate = new Date(this.tempSelectedYear, 11, 31);
    this.endDate.setHours(23, 59, 59, 999);
    this.showYearPicker = false;
    this.loadStatistics();
  }

  /**
   * ç¡®è®¤æœˆä»½é€‰æ‹©
   */
  confirmMonthSelection(): void {
    this.startDate = new Date(this.tempSelectedYear, this.tempSelectedMonth, 1);
    this.startDate.setHours(0, 0, 0, 0);
    const lastDay = new Date(this.tempSelectedYear, this.tempSelectedMonth + 1, 0);
    this.endDate = new Date(lastDay);
    this.endDate.setHours(23, 59, 59, 999);
    this.showMonthPicker = false;
    this.loadStatistics();
  }

  /**
   * ç¡®è®¤å‘¨é€‰æ‹©
   */
  confirmWeekSelection(): void {
    const range = this.getWeekDateRange(this.tempSelectedYear, this.tempSelectedWeek);
    this.startDate = range.start;
    this.endDate = range.end;
    this.showWeekPicker = false;
    this.loadStatistics();
  }

  /**
   * ç¡®è®¤è‡ªå®šä¹‰èŒƒå›´é€‰æ‹©
   */
  confirmCustomRangeSelection(): void {
    this.showCustomRangePicker = false;
    this.loadStatistics();
  }

  /**
   * æ„å»ºæ€»ç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  buildSummaryCard() {
    Row() {
      Column() {
        Text('æ”¯å‡º')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
        Text(`Â¥${this.totalExpense.toFixed(2)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_DANGER)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      Column() {
        Text('æ”¶å…¥')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
        Text(`Â¥${this.totalIncome.toFixed(2)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_SUCCESS)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      Column() {
        Text('ç»“ä½™')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
        Text(`Â¥${this.totalBalance.toFixed(2)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.COLOR_PRIMARY)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }


  /**
   * æ„å»ºAIåˆ†æå»ºè®®
   */
  @Builder
  buildAIAnalysis() {
    Column() {
      Row() {
        Text('ğŸ¤–')
          .fontSize(20)
        Text('AIåˆ†æäº†è§£æ‚¨')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .margin({ left: 8 })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Column() {
        Text('ğŸ’¡')
          .fontSize(24)
          .margin({ bottom: 8 })
        
        Text(this.getAIAnalysisText())
          .fontSize(13)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .textAlign(TextAlign.Center)
          .lineHeight(20)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFF8E1')
      .borderRadius(12)
      
      Text('æ›´å¤šæ¶ˆè´¹åˆ†æï¼Œè¯·è®°å½•æ›´å¤š~')
        .fontSize(12)
        .fontColor(Constants.COLOR_TEXT_SECONDARY)
        .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }

  /**
   * è·å–AIåˆ†ææ–‡æœ¬
   */
  getAIAnalysisText(): string {
    if (this.allBillsInRange.length === 0) {
      return 'æœ¬æœŸæš‚æ— è´¦å•è®°å½•ï¼Œå¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€ç¬”è´¦å•å§ï¼';
    }
    
    // æ‰¾å‡ºæœ€å¤§æ”¯å‡ºåˆ†ç±»
    let topCategory = '';
    let topAmount = 0;
    this.categoryStats.forEach(stat => {
      if (stat.amount > topAmount) {
        topAmount = stat.amount;
        topCategory = stat.name;
      }
    });
    
    if (topCategory) {
      const avgDaily = this.totalExpense / Math.max(this.dailyStats.length, 1);
      return `æœ¬æœŸæœ€å¤§æ”¯å‡ºä¸ºã€Œ${topCategory}ã€ï¼ŒèŠ±è´¹Â¥${topAmount.toFixed(2)}ï¼Œ` +
        `æ—¥å‡æ¶ˆè´¹Â¥${avgDaily.toFixed(2)}ã€‚å»ºè®®åˆç†è§„åˆ’æ”¯å‡ºå“¦~`;
    }
    
    return 'ç»§ç»­è®°å½•è´¦å•ï¼Œè·å–æ›´ç²¾å‡†çš„æ¶ˆè´¹åˆ†æ~';
  }

  /**
   * æ„å»ºæ¶ˆè´¹è¶‹åŠ¿
   */
  @Builder
  buildDailyTrend() {
    Column() {
      Text('æ¶ˆè´¹è¶‹åŠ¿')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .width('100%')
        .margin({ bottom: 16 })
      
      // ç®€æ˜“æŸ±çŠ¶å›¾
      Row() {
        ForEach(this.dailyStats.slice(-7), (stats: DailyStats) => {
          Column() {
            // æŸ±å­
            Column()
              .width(24)
              .height(`${Math.max((stats.expense / this.getMaxDailyExpense()) * 100, 5)}%`)
              .backgroundColor(Constants.COLOR_PRIMARY)
              .borderRadius({ topLeft: 4, topRight: 4 })
            
            // æ—¥æœŸæ ‡ç­¾
            Text(stats.dateLabel)
              .fontSize(10)
              .fontColor(Constants.COLOR_TEXT_SECONDARY)
              .margin({ top: 4 })
          }
          .layoutWeight(1)
          .height(120)
          .justifyContent(FlexAlign.End)
          .alignItems(HorizontalAlign.Center)
        })
      }
      .width('100%')
      .height(140)
      .padding({ top: 20 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }


  /**
   * æ„å»ºåˆ†ç±»æ„æˆ
   */
  @Builder
  buildCategoryChart() {
    Column() {
      // æ ‡é¢˜å’Œåˆ‡æ¢
      Row() {
        Text('åˆ†ç±»æ„æˆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Text('æ”¯å‡º')
          .fontSize(13)
          .fontColor(this.showCategoryExpenseTab ? '#FFFFFF' : Constants.COLOR_TEXT_SECONDARY)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(this.showCategoryExpenseTab ? Constants.COLOR_PRIMARY : Constants.COLOR_BACKGROUND)
          .borderRadius(14)
          .margin({ right: 8 })
          .onClick(() => { this.showCategoryExpenseTab = true; })
        
        Text('æ”¶å…¥')
          .fontSize(13)
          .fontColor(!this.showCategoryExpenseTab ? '#FFFFFF' : Constants.COLOR_TEXT_SECONDARY)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(!this.showCategoryExpenseTab ? Constants.COLOR_SUCCESS : Constants.COLOR_BACKGROUND)
          .borderRadius(14)
          .onClick(() => { this.showCategoryExpenseTab = false; })
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // æ€»é‡‘é¢æ˜¾ç¤º
      Column() {
        Text(this.showCategoryExpenseTab ? 'æ€»æ”¯å‡º' : 'æ€»æ”¶å…¥')
          .fontSize(12)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
        Text(`Â¥${this.showCategoryExpenseTab ? this.totalExpense.toFixed(2) : this.totalIncome.toFixed(2)}`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.showCategoryExpenseTab ? Constants.COLOR_DANGER : Constants.COLOR_SUCCESS)
          .margin({ top: 4 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 20 })
      
      // åˆ†ç±»åˆ—è¡¨
      if ((this.showCategoryExpenseTab ? this.categoryStats : this.categoryStatsForIncome).length > 0) {
        ForEach(this.showCategoryExpenseTab ? this.categoryStats : this.categoryStatsForIncome, (stat: CategoryStats) => {
          Row() {
            // å›¾æ ‡
            Text(stat.icon)
              .fontSize(20)
              .width(32)
            
            // åˆ†ç±»åå’Œç™¾åˆ†æ¯”
            Column() {
              Row() {
                Text(stat.name)
                  .fontSize(14)
                  .fontColor(Constants.COLOR_TEXT_PRIMARY)
                Text(`${stat.percentage.toFixed(1)}%`)
                  .fontSize(12)
                  .fontColor(Constants.COLOR_TEXT_SECONDARY)
                  .margin({ left: 8 })
              }
              
              // è¿›åº¦æ¡
              Row() {
                Row()
                  .width(`${stat.percentage}%`)
                  .height(6)
                  .backgroundColor(Constants.COLOR_PRIMARY)
                  .borderRadius(3)
              }
              .width('100%')
              .height(6)
              .backgroundColor(Constants.COLOR_BORDER)
              .borderRadius(3)
              .margin({ top: 6 })
            }
            .layoutWeight(1)
            .margin({ left: 12 })
            
            // é‡‘é¢
            Text(`Â¥${stat.amount.toFixed(2)}`)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(Constants.COLOR_TEXT_PRIMARY)
          }
          .width('100%')
          .padding({ top: 10, bottom: 10 })
        })
      } else {
        Text('æš‚æ— æ•°æ®')
          .fontSize(14)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .padding(20)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }


  /**
   * æ„å»ºå•ç¬”æ”¶æ”¯æ’è¡Œ
   */
  @Builder
  buildTopBillsList() {
    Column() {
      // æ ‡é¢˜å’Œåˆ‡æ¢
      Row() {
        Text('æ”¶å…¥æ’è¡Œ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Text('æ”¯å‡º')
          .fontSize(13)
          .fontColor(this.showTopBillsExpenseTab ? '#FFFFFF' : Constants.COLOR_TEXT_SECONDARY)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(this.showTopBillsExpenseTab ? Constants.COLOR_PRIMARY : Constants.COLOR_BACKGROUND)
          .borderRadius(14)
          .margin({ right: 8 })
          .onClick(() => { this.showTopBillsExpenseTab = true; })
        
        Text('æ”¶å…¥')
          .fontSize(13)
          .fontColor(!this.showTopBillsExpenseTab ? '#FFFFFF' : Constants.COLOR_TEXT_SECONDARY)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(!this.showTopBillsExpenseTab ? Constants.COLOR_SUCCESS : Constants.COLOR_BACKGROUND)
          .borderRadius(14)
          .onClick(() => { this.showTopBillsExpenseTab = false; })
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // æ’è¡Œåˆ—è¡¨
      if ((this.showTopBillsExpenseTab ? this.topExpenses : this.topIncomes).length > 0) {
        ForEach(this.showTopBillsExpenseTab ? this.topExpenses : this.topIncomes, (bill: Bill, index: number) => {
          Row() {
            // æ’å
            Text(`${index + 1}`)
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor(index < 3 ? Constants.COLOR_PRIMARY : Constants.COLOR_TEXT_SECONDARY)
              .width(24)
            
            // å›¾æ ‡
            Column() {
              Text(this.getCategoryIcon(bill.category))
                .fontSize(18)
            }
            .width(36)
            .height(36)
            .backgroundColor(bill.isIncome() ? 'rgba(255, 167, 38, 0.15)' : 'rgba(255, 107, 53, 0.1)')
            .borderRadius(18)
            .justifyContent(FlexAlign.Center)
            .margin({ left: 8 })
            
            // æè¿°
            Column() {
              Text(bill.description || this.getCategoryName(bill.category))
                .fontSize(14)
                .fontColor(Constants.COLOR_TEXT_PRIMARY)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              Text(Utils.formatDate(bill.date, 'MMæœˆDDæ—¥'))
                .fontSize(12)
                .fontColor(Constants.COLOR_TEXT_SECONDARY)
                .margin({ top: 2 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 12 })
            
            // é‡‘é¢
            Text(`Â¥${bill.amount.toFixed(2)}`)
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor(bill.isIncome() ? Constants.COLOR_SUCCESS : Constants.COLOR_DANGER)
          }
          .width('100%')
          .padding({ top: 10, bottom: 10 })
        })
      } else {
        Text('æš‚æ— æ•°æ®')
          .fontSize(14)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .padding(20)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }


  /**
   * æ„å»ºè´¦å•æ±‡æ€»
   */
  @Builder
  buildBillSummary() {
    Column() {
      Text('è´¦å•æ±‡æ€»')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(Constants.COLOR_TEXT_PRIMARY)
        .width('100%')
        .margin({ bottom: 16 })
      
      // è¡¨å¤´
      Row() {
        Text('æ—¥æœŸ')
          .fontSize(13)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text(this.getAmountLabel('æ”¯å‡º'))
          .fontSize(13)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text(this.getAmountLabel('æ”¶å…¥'))
          .fontSize(13)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text(this.getAmountLabel('ç»“ä½™'))
          .fontSize(13)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .padding({ top: 10, bottom: 10 })
      .backgroundColor(Constants.COLOR_BACKGROUND)
      .borderRadius(8)
      
      // æ•°æ®è¡Œ
      ForEach(this.dailyStats.slice().reverse().slice(0, 10), (stats: DailyStats) => {
        Row() {
          Text(stats.dateLabel)
            .fontSize(13)
            .fontColor(Constants.COLOR_TEXT_PRIMARY)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          Text(this.formatAmount(stats.expense, true))
            .fontSize(13)
            .fontColor(stats.expense > 0 ? Constants.COLOR_DANGER : Constants.COLOR_TEXT_SECONDARY)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          Text(this.formatAmount(stats.income, false))
            .fontSize(13)
            .fontColor(stats.income > 0 ? Constants.COLOR_SUCCESS : Constants.COLOR_TEXT_SECONDARY)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          Text(this.formatBalanceAmount(stats.income - stats.expense))
            .fontSize(13)
            .fontColor((stats.income - stats.expense) >= 0 ? Constants.COLOR_PRIMARY : Constants.COLOR_DANGER)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .padding({ top: 12, bottom: 12 })
        .borderWidth({ bottom: 1 })
        .borderColor(Constants.COLOR_DIVIDER)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }

  /**
   * è·å–åˆ†ç±»å›¾æ ‡
   */
  getCategoryIcon(category: BillCategory): string {
    if (category === BillCategory.FOOD) return 'ğŸ”';
    if (category === BillCategory.TRANSPORT) return 'ğŸš—';
    if (category === BillCategory.SHOPPING) return 'ğŸ›ï¸';
    if (category === BillCategory.ENTERTAINMENT) return 'ğŸ¬';
    if (category === BillCategory.MEDICAL) return 'ğŸ¥';
    if (category === BillCategory.EDUCATION) return 'ğŸ“š';
    if (category === BillCategory.HOUSING) return 'ğŸ ';
    if (category === BillCategory.UTILITIES) return 'ğŸ’¡';
    if (category === BillCategory.SALARY) return 'ğŸ’°';
    if (category === BillCategory.BONUS) return 'ğŸ';
    if (category === BillCategory.INVESTMENT) return 'ğŸ“ˆ';
    if (category === BillCategory.GIFT) return 'ğŸ';
    return 'ğŸ“';
  }

  /**
   * è·å–é‡‘é¢æ ‡ç­¾ï¼ˆæ ¹æ®å‘¨æœŸç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡ç­¾ï¼‰
   */
  getAmountLabel(baseLabel: string): string {
    if (this.period === 'year') {
      return `${baseLabel}(å¹´å‡)`;
    } else if (this.period === 'month' || this.period === 'week') {
      return `${baseLabel}(æ—¥å‡)`;
    } else {
      return `${baseLabel}(æ€»è®¡)`;
    }
  }

  /**
   * æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤ºï¼ˆæ ¹æ®å‘¨æœŸç±»å‹æ˜¾ç¤ºæ—¥å‡æˆ–æ€»è®¡ï¼‰
   * å¹´ç•Œé¢ï¼šæ˜¾ç¤ºå¹´å‡ï¼ˆæ€»é‡‘é¢/æ€»å¤©æ•°ï¼‰
   * æœˆå’Œå‘¨ç•Œé¢ï¼šæ˜¾ç¤ºæ—¥å‡ï¼ˆè¯¥å¤©çš„é‡‘é¢ï¼Œæœ¬èº«å°±æ˜¯æ—¥å‡ï¼‰
   * è‡ªå®šä¹‰ç•Œé¢ï¼šæ˜¾ç¤ºæ€»è®¡ï¼ˆè¯¥å¤©çš„æ€»é‡‘é¢ï¼‰
   */
  formatAmount(amount: number, isExpense: boolean): string {
    if (amount <= 0) return '-';
    
    let displayAmount = amount;
    
    if (this.period === 'year') {
      // å¹´ç•Œé¢ï¼šæ˜¾ç¤ºå¹´å‡ï¼ˆæ€»é‡‘é¢é™¤ä»¥æ€»å¤©æ•°ï¼‰
      const days = Math.floor((this.endDate.getTime() - this.startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      const totalAmount = isExpense ? this.totalExpense : this.totalIncome;
      displayAmount = days > 0 ? totalAmount / days : 0;
    } else if (this.period === 'month' || this.period === 'week') {
      // æœˆå’Œå‘¨ç•Œé¢ï¼šæ˜¾ç¤ºæ—¥å‡ï¼ˆè¯¥å¤©çš„é‡‘é¢æœ¬èº«å°±æ˜¯æ—¥å‡ï¼Œä¸éœ€è¦é¢å¤–è®¡ç®—ï¼‰
      displayAmount = amount;
    }
    // custom ç•Œé¢æ˜¾ç¤ºæ€»è®¡ï¼Œç›´æ¥ä½¿ç”¨amount
    
    return `Â¥${displayAmount.toFixed(2)}`;
  }

  /**
   * æ ¼å¼åŒ–ç»“ä½™é‡‘é¢æ˜¾ç¤º
   */
  formatBalanceAmount(balance: number): string {
    let displayAmount = balance;
    
    if (this.period === 'year') {
      // å¹´ç•Œé¢ï¼šæ˜¾ç¤ºå¹´å‡ç»“ä½™ï¼ˆæ€»ç»“ä½™é™¤ä»¥æ€»å¤©æ•°ï¼‰
      const days = Math.floor((this.endDate.getTime() - this.startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      displayAmount = days > 0 ? this.totalBalance / days : 0;
    } else if (this.period === 'month' || this.period === 'week') {
      // æœˆå’Œå‘¨ç•Œé¢ï¼šæ˜¾ç¤ºæ—¥å‡ç»“ä½™ï¼ˆè¯¥å¤©çš„ç»“ä½™ï¼Œæœ¬èº«å°±æ˜¯æ—¥å‡ï¼‰
      displayAmount = balance;
    }
    // custom ç•Œé¢æ˜¾ç¤ºæ€»è®¡ç»“ä½™
    
    return `Â¥${displayAmount.toFixed(2)}`;
  }

  /**
   * è·å–åˆ†ç±»åç§°
   */
  getCategoryName(category: BillCategory): string {
    if (category === BillCategory.FOOD) return 'é¤é¥®';
    if (category === BillCategory.TRANSPORT) return 'äº¤é€š';
    if (category === BillCategory.SHOPPING) return 'è´­ç‰©';
    if (category === BillCategory.ENTERTAINMENT) return 'å¨±ä¹';
    if (category === BillCategory.MEDICAL) return 'åŒ»ç–—';
    if (category === BillCategory.EDUCATION) return 'æ•™è‚²';
    if (category === BillCategory.HOUSING) return 'ä½æˆ¿';
    if (category === BillCategory.UTILITIES) return 'æ°´ç”µ';
    if (category === BillCategory.SALARY) return 'å·¥èµ„';
    if (category === BillCategory.BONUS) return 'å¥–é‡‘';
    if (category === BillCategory.INVESTMENT) return 'æŠ•èµ„';
    if (category === BillCategory.GIFT) return 'ç¤¼é‡‘';
    if (category === BillCategory.OTHER_EXPENSE) return 'å…¶ä»–æ”¯å‡º';
    if (category === BillCategory.OTHER_INCOME) return 'å…¶ä»–æ”¶å…¥';
    return 'å…¶ä»–';
  }

  /**
   * æ„å»ºå¹´ä»½é€‰æ‹©å™¨
   */
  @Builder
  buildYearPicker() {
    Column() {
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.showYearPicker = false;
          })
        
        Blank()
        
        Text('é€‰æ‹©å¹´ä»½')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            this.confirmYearSelection();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      
      TextPicker({ 
        range: this.getYears().map(y => `${y}å¹´`), 
        selected: this.tempSelectedYear - (new Date().getFullYear() - 50) 
      })
        .onChange((value: string | string[], index: number | number[]) => {
          if (typeof index === 'number') {
            this.tempSelectedYear = new Date().getFullYear() - 50 + index;
          }
        })
        .height(200)
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
  }

  /**
   * æ„å»ºæœˆä»½é€‰æ‹©å™¨
   */
  @Builder
  buildMonthPicker() {
    Column() {
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.showMonthPicker = false;
          })
        
        Blank()
        
        Text('é€‰æ‹©å¹´æœˆ')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            this.confirmMonthSelection();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      
      Row() {
        TextPicker({ 
          range: this.getYears().map(y => `${y}å¹´`), 
          selected: this.tempSelectedYear - (new Date().getFullYear() - 50) 
        })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.tempSelectedYear = new Date().getFullYear() - 50 + index;
            }
          })
        
        TextPicker({ 
          range: this.getMonths().map(m => `${m + 1}æœˆ`), 
          selected: this.tempSelectedMonth 
        })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.tempSelectedMonth = index;
            }
          })
      }
      .width('100%')
      .height(200)
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
  }

  /**
   * æ„å»ºå‘¨é€‰æ‹©å™¨
   */
  @Builder
  buildWeekPicker() {
    Column() {
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.showWeekPicker = false;
          })
        
        Blank()
        
        Text('é€‰æ‹©å‘¨')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            this.confirmWeekSelection();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      
      Row() {
        TextPicker({ 
          range: this.getYears().map(y => `${y}å¹´`), 
          selected: this.tempSelectedYear - (new Date().getFullYear() - 50) 
        })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.tempSelectedYear = new Date().getFullYear() - 50 + index;
            }
          })
        
        TextPicker({ 
          range: this.getWeeks().map(w => `ç¬¬${w}å‘¨`), 
          selected: this.tempSelectedWeek - 1 
        })
          .layoutWeight(1)
          .onChange((value: string | string[], index: number | number[]) => {
            if (typeof index === 'number') {
              this.tempSelectedWeek = index + 1;
            }
          })
      }
      .width('100%')
      .height(200)
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
  }

  /**
   * æ„å»ºè‡ªå®šä¹‰èŒƒå›´é€‰æ‹©å™¨
   */
  @Builder
  buildCustomRangePicker() {
    Column() {
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .onClick(() => {
            this.showCustomRangePicker = false;
          })
        
        Blank()
        
        Text('é€‰æ‹©æ—¥æœŸèŒƒå›´')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
        
        Blank()
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .fontColor(Constants.COLOR_PRIMARY)
          .onClick(() => {
            this.confirmCustomRangeSelection();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      
      Column() {
        Text('å¼€å§‹æ—¥æœŸ')
          .fontSize(14)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .width('100%')
          .margin({ bottom: 8 })
        
        Text(Utils.formatDate(this.startDate, 'YYYY-MM-DD'))
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .width('100%')
          .padding(12)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .borderRadius(8)
          .onClick(() => {
            DatePickerDialog.show({
              start: new Date('2020-1-1'),
              end: new Date('2100-12-31'),
              selected: this.startDate,
              showTime: false,
              onDateAccept: (value: Date) => {
                this.startDate = new Date(value);
                this.startDate.setHours(0, 0, 0, 0);
              }
            });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      
      Column() {
        Text('ç»“æŸæ—¥æœŸ')
          .fontSize(14)
          .fontColor(Constants.COLOR_TEXT_SECONDARY)
          .width('100%')
          .margin({ bottom: 8 })
        
        Text(Utils.formatDate(this.endDate, 'YYYY-MM-DD'))
          .fontSize(16)
          .fontColor(Constants.COLOR_TEXT_PRIMARY)
          .width('100%')
          .padding(12)
          .backgroundColor(Constants.COLOR_BACKGROUND)
          .borderRadius(8)
          .onClick(() => {
            DatePickerDialog.show({
              start: this.startDate,
              end: new Date('2100-12-31'),
              selected: this.endDate < this.startDate ? this.startDate : this.endDate,
              showTime: false,
              onDateAccept: (value: Date) => {
                this.endDate = new Date(value);
                this.endDate.setHours(23, 59, 59, 999);
              }
            });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    }
    .width('100%')
    .backgroundColor(Constants.COLOR_CARD_BACKGROUND)
  }
}
